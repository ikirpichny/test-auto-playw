LavaPack.loadBundle([[98,{"../../shared/constants/app":4178,"../../shared/constants/hardware-wallets":4184,"../../shared/constants/keyring":4185,"../../shared/constants/logs":4187,"../../shared/constants/metametrics":4188,"../../shared/constants/methods-tags":4189,"../../shared/constants/network":4190,"../../shared/constants/permissions":4194,"../../shared/constants/smartTransactions":4197,"../../shared/constants/swaps":4199,"../../shared/constants/time":4201,"../../shared/constants/tokens":4202,"../../shared/constants/transaction":4203,"../../shared/lib/metamask-controller-utils":4207,"../../shared/lib/token-util":4211,"../../shared/modules/mv3.utils":4228,"../../shared/modules/network.utils":4229,"../../shared/modules/selectors":4235,"../../shared/modules/string-utils":4238,"../../shared/modules/transaction.utils":4240,"../../shared/notifications":4242,"./controllers/account-order":6,"./controllers/alert":7,"./controllers/app-metadata":8,"./controllers/app-state":9,"./controllers/authentication/authentication-controller":11,"./controllers/decrypt-message":13,"./controllers/encryption-public-key":14,"./controllers/metametrics":15,"./controllers/network-order":16,"./controllers/onboarding":17,"./controllers/permissions":21,"./controllers/preferences":24,"./controllers/swaps":25,"./controllers/user-storage/user-storage-controller":29,"./detect-multiple-instances":30,"./lib/AccountIdentitiesPetnamesBridge":33,"./lib/AddressBookPetnamesBridge":34,"./lib/ComposableObservableStore":35,"./lib/SnapsNameProvider":36,"./lib/WeakRefObjectMap":37,"./lib/account-tracker":38,"./lib/backup":39,"./lib/createDupeReqFilterMiddleware":40,"./lib/createLoggerMiddleware":41,"./lib/createMetaRPCHandler":42,"./lib/createMetamaskMiddleware":43,"./lib/createOnboardingMiddleware":44,"./lib/createOriginMiddleware":45,"./lib/createRPCMethodTrackingMiddleware":46,"./lib/createTabIdMiddleware":48,"./lib/encryptor-factory":49,"./lib/hardware-keyring-builder-factory":57,"./lib/keyring-snaps-permissions":58,"./lib/offscreen-bridge/lattice-offscreen-keyring":65,"./lib/offscreen-bridge/ledger-offscreen-bridge":66,"./lib/offscreen-bridge/trezor-offscreen-bridge":67,"./lib/ppom/indexed-db-backend":68,"./lib/ppom/ppom":71,"./lib/ppom/ppom-middleware":69,"./lib/rpc-method-middleware":82,"./lib/segment":84,"./lib/snap-keyring":88,"./lib/stream-utils":93,"./lib/transaction/metrics":94,"./lib/transaction/smart-transactions":95,"./lib/transaction/util":96,"./lib/util":97,"./snaps/preinstalled-snaps":224,"./translate":225,"@keystonehq/metamask-airgapped-keyring":561,"@metamask/accounts-controller":1018,"@metamask/address-book-controller":1021,"@metamask/announcement-controller":1029,"@metamask/approval-controller":1038,"@metamask/assets-controllers":1063,"@metamask/base-controller":1085,"@metamask/controller-utils":1094,"@metamask/ens-controller":1118,"@metamask/eth-json-rpc-filters":1131,"@metamask/eth-json-rpc-filters/subscriptionManager":1134,"@metamask/eth-json-rpc-middleware":1146,"@metamask/eth-keyring-controller":1161,"@metamask/eth-ledger-bridge-keyring":1184,"@metamask/eth-query":1188,"@metamask/eth-trezor-keyring":1246,"@metamask/ethjs-query":1263,"@metamask/gas-fee-controller":1271,"@metamask/keyring-controller":1374,"@metamask/logging-controller":1376,"@metamask/name-controller":1411,"@metamask/network-controller":1426,"@metamask/notification-controller":1446,"@metamask/obs-store":1494,"@metamask/obs-store/dist/asStream":1493,"@metamask/permission-controller":1510,"@metamask/permission-log-controller":1529,"@metamask/phishing-controller":1531,"@metamask/ppom-validator":1570,"@metamask/queued-request-controller":1587,"@metamask/rate-limit-controller":1603,"@metamask/scure-bip39/dist/wordlists/english":1615,"@metamask/selected-network-controller":1627,"@metamask/signature-controller":1635,"@metamask/smart-transactions-controller":1645,"@metamask/snaps-controllers":1806,"@metamask/snaps-rpc-methods":1887,"@metamask/snaps-utils":1924,"@metamask/transaction-controller":1960,"@metamask/user-operation-controller":1979,"@sentry/browser":2104,"await-semaphore":2560,buffer:2666,"eth-lattice-keyring":2866,"eth-rpc-errors":2897,events:2968,"json-rpc-engine":3328,"json-rpc-middleware-stream":3333,lodash:3509,loglevel:3515,nanoid:3602,pump:3693},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){(function(t){(function(){Object.defineProperty(r,"__esModule",{value:!0}),r.default=r.METAMASK_CONTROLLER_EVENTS=void 0;var n=bt(e("events")),o=bt(e("pump")),s=e("@metamask/assets-controllers"),i=e("@metamask/obs-store"),a=e("@metamask/obs-store/dist/asStream"),l=e("json-rpc-engine"),c=e("json-rpc-middleware-stream"),d=e("@metamask/eth-json-rpc-middleware"),h=e("lodash"),u=e("@metamask/eth-keyring-controller"),p=e("@metamask/keyring-controller"),g=bt(e("@metamask/eth-json-rpc-filters")),C=bt(e("@metamask/eth-json-rpc-filters/subscriptionManager")),m=e("eth-rpc-errors"),b=e("await-semaphore"),w=bt(e("loglevel")),k=e("@metamask/eth-trezor-keyring"),f=e("@metamask/eth-ledger-bridge-keyring"),y=bt(e("eth-lattice-keyring")),S=e("@keystonehq/metamask-airgapped-keyring"),v=bt(e("@metamask/eth-query")),A=bt(e("@metamask/ethjs-query")),M=bt(e("nanoid")),T=e("@sentry/browser"),P=e("@metamask/address-book-controller"),N=e("@metamask/approval-controller"),E=e("@metamask/base-controller"),R=e("@metamask/ens-controller"),I=e("@metamask/phishing-controller"),O=e("@metamask/announcement-controller"),F=e("@metamask/network-controller"),U=e("@metamask/gas-fee-controller"),L=e("@metamask/permission-controller"),_=bt(e("@metamask/smart-transactions-controller")),D=e("@metamask/selected-network-controller"),x=e("@metamask/logging-controller"),B=e("@metamask/permission-log-controller"),q=e("@metamask/rate-limit-controller"),j=e("@metamask/notification-controller"),K=e("@metamask/snaps-controllers"),G=e("@metamask/snaps-rpc-methods"),V=e("@metamask/accounts-controller"),$=e("@metamask/signature-controller"),H=e("@metamask/ppom-validator"),W=e("@metamask/controller-utils"),Q=e("@metamask/scure-bip39/dist/wordlists/english"),z=e("@metamask/name-controller"),Y=e("@metamask/queued-request-controller"),J=e("@metamask/user-operation-controller"),X=e("@metamask/transaction-controller"),Z=e("@metamask/snaps-utils"),ee=e("../../shared/constants/methods-tags"),te=e("../../shared/constants/transaction"),re=e("../../shared/constants/swaps"),ne=e("../../shared/constants/network"),oe=e("../../shared/constants/smartTransactions"),se=e("../../shared/constants/hardware-wallets"),ie=e("../../shared/constants/keyring"),ae=e("../../shared/constants/permissions"),le=e("../../shared/notifications"),ce=e("../../shared/constants/time"),de=e("../../shared/constants/app"),he=e("../../shared/constants/metametrics"),ue=e("../../shared/constants/logs"),pe=e("../../shared/lib/token-util"),ge=e("../../shared/modules/string-utils"),Ce=e("../../shared/modules/transaction.utils"),me=e("../../shared/constants/tokens"),be=e("../../shared/lib/metamask-controller-utils"),we=e("../../shared/modules/mv3.utils"),ke=e("../../shared/modules/network.utils"),fe=e("../../shared/modules/selectors"),ye=e("./lib/transaction/metrics"),Se=e("./lib/transaction/smart-transactions"),ve=e("./lib/keyring-snaps-permissions"),Ae=e("./lib/SnapsNameProvider"),Me=e("./lib/AddressBookPetnamesBridge"),Te=e("./lib/AccountIdentitiesPetnamesBridge"),Pe=e("./lib/ppom/ppom-middleware"),Ne=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=mt(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var i=o?Object.getOwnPropertyDescriptor(e,s):null;i&&(i.get||i.set)?Object.defineProperty(n,s,i):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(e("./lib/ppom/ppom")),Ee=e("./detect-multiple-instances"),Re=bt(e("./lib/ComposableObservableStore")),Ie=bt(e("./lib/account-tracker")),Oe=bt(e("./lib/createDupeReqFilterMiddleware")),Fe=bt(e("./lib/createLoggerMiddleware")),Ue=e("./lib/rpc-method-middleware"),Le=bt(e("./lib/createOriginMiddleware")),_e=bt(e("./lib/createTabIdMiddleware")),De=e("./controllers/network-order"),xe=e("./controllers/account-order"),Be=bt(e("./lib/createOnboardingMiddleware")),qe=e("./lib/stream-utils"),je=bt(e("./controllers/preferences")),Ke=bt(e("./controllers/app-state")),Ge=bt(e("./controllers/alert")),Ve=bt(e("./controllers/onboarding")),$e=bt(e("./lib/backup")),He=bt(e("./controllers/decrypt-message")),We=bt(e("./controllers/swaps")),Qe=bt(e("./controllers/metametrics")),ze=e("./lib/segment"),Ye=bt(e("./lib/createMetaRPCHandler")),Je=e("./lib/util"),Xe=bt(e("./lib/createMetamaskMiddleware")),Ze=e("./lib/hardware-keyring-builder-factory"),et=bt(e("./controllers/encryption-public-key")),tt=bt(e("./controllers/app-metadata")),rt=e("./controllers/permissions"),nt=bt(e("./lib/createRPCMethodTrackingMiddleware")),ot=e("./lib/ppom/indexed-db-backend"),st=e("./translate"),it=e("./lib/offscreen-bridge/trezor-offscreen-bridge"),at=e("./lib/offscreen-bridge/ledger-offscreen-bridge"),lt=e("./lib/snap-keyring"),ct=e("./lib/encryptor-factory"),dt=e("./lib/transaction/util"),ht=e("./lib/offscreen-bridge/lattice-offscreen-keyring"),ut=bt(e("./snaps/preinstalled-snaps")),pt=bt(e("./controllers/authentication/authentication-controller")),gt=bt(e("./controllers/user-storage/user-storage-controller")),Ct=e("./lib/WeakRefObjectMap");function mt(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(mt=function(e){return e?r:t})(e)}function bt(e){return e&&e.__esModule?e:{default:e}}function wt(e,t){!function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}(e,t),t.add(e)}function kt(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(r!==undefined){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ft(e,t,r){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return r}r.METAMASK_CONTROLLER_EVENTS={UPDATE_BADGE:"updateBadge",APPROVAL_STATE_CHANGE:"ApprovalController:stateChange",QUEUED_REQUEST_STATE_CHANGE:"QueuedRequestController:stateChange"};var yt=new WeakSet,St=new WeakSet,vt=new WeakSet;class At extends n.default{constructor(e){var t,r;super(),wt(this,vt),wt(this,St),wt(this,yt),kt(this,"_trackSnapExportUsage",(0,h.wrap)((0,h.memoize)((()=>(0,h.throttle)(((e,t,r,n)=>{var o;return this.metaMetricsController.trackEvent({event:he.MetaMetricsEventName.SnapExportUsed,category:he.MetaMetricsEventCategory.Snaps,properties:{snap_id:e,export:t,snap_category:null===(o=this._getSnapMetadata(e))||void 0===o?void 0:o.category,success:r,origin:n}})}),60*ce.SECOND)),((e,t,r,n)=>`${e}${t}${n}`)),((e,...t)=>e(...t)(...t)))),kt(this,"handleWatchAssetRequest",(({asset:e,type:t,origin:r,networkClientId:n})=>{switch(t){case W.ERC20:return this.tokensController.watchAsset({asset:e,type:t,networkClientId:n});case W.ERC721:case W.ERC1155:return this.nftController.watchNft(e,t,r);default:throw new Error(`Asset type ${t} not supported`)}})),kt(this,"removePermissionsFor",(e=>{try{this.permissionController.revokePermissions(e)}catch(e){if(!(e instanceof L.PermissionsRequestNotFoundError))throw e}})),kt(this,"updateCaveat",((e,t,r,n)=>{try{this.controllerMessenger.call("PermissionController:updateCaveat",e,t,r,n)}catch(e){if(!(e instanceof L.PermissionsRequestNotFoundError))throw e}})),kt(this,"updateNetworksList",(e=>{try{this.networkOrderController.updateNetworksList(e)}catch(e){throw w.default.error(e.message),e}})),kt(this,"updateAccountsList",(e=>{try{this.accountOrderController.updateAccountsList(e)}catch(e){throw w.default.error(e.message),e}})),kt(this,"updateHiddenAccountsList",(e=>{try{this.accountOrderController.updateHiddenAccountsList(e)}catch(e){throw w.default.error(e.message),e}})),kt(this,"rejectPermissionsRequest",(e=>{try{this.permissionController.rejectPermissionsRequest(e)}catch(e){if(!(e instanceof L.PermissionsRequestNotFoundError))throw e}})),kt(this,"acceptPermissionsRequest",(e=>{try{this.permissionController.acceptPermissionsRequest(e)}catch(e){if(!(e instanceof L.PermissionsRequestNotFoundError))throw e}})),kt(this,"resolvePendingApproval",(async(e,t,r)=>{try{await this.approvalController.accept(e,t,r)}catch(e){if(!(e instanceof N.ApprovalRequestNotFoundError))throw e}})),kt(this,"rejectPendingApproval",((e,t)=>{try{this.approvalController.reject(e,new m.EthereumRpcError(t.code,t.message,t.data))}catch(e){if(!(e instanceof N.ApprovalRequestNotFoundError))throw e}}));const{isFirstMetaMaskControllerSetup:n}=e;this.defaultMaxListeners=20,this.sendUpdate=(0,h.debounce)(this.privateSendUpdate.bind(this),200*ce.MILLISECOND),this.opts=e,this.extension=e.browser,this.platform=e.platform,this.notificationManager=e.notificationManager;const o=e.initState||{},i=this.platform.getVersion();this.recordFirstTimeInfo(o),this.featureFlags=e.featureFlags,this.activeControllerConnections=0,this.getRequestAccountTabIds=e.getRequestAccountTabIds,this.getOpenMetamaskTabsIds=e.getOpenMetamaskTabsIds,this.controllerMessenger=new E.ControllerMessenger,this.loggingController=new x.LoggingController({messenger:this.controllerMessenger.getRestricted({name:"LoggingController"}),state:o.LoggingController}),this.localStoreApiWrapper=e.localStore,this.currentMigrationVersion=e.currentMigrationVersion,this.store=new Re.default({state:o,controllerMessenger:this.controllerMessenger,persist:!0}),this.connections={},this.createVaultMutex=new b.Mutex,this.extension.runtime.onInstalled.addListener((e=>{"update"===e.reason&&("8.1.0"===i&&this.platform.openExtensionInBrowser(),this.loggingController.add({type:x.LogType.GenericLog,data:{event:ue.LOG_EVENT.VERSION_UPDATE,previousVersion:e.previousVersion,version:i}}))})),this.appMetadataController=new tt.default({state:o.AppMetadataController,currentMigrationVersion:this.currentMigrationVersion,currentAppVersion:i});const a=()=>{this.encryptionPublicKeyController.clearUnapproved(),this.decryptMessageController.clearUnapproved(),this.signatureController.clearUnapproved(),this.approvalController.clear(m.ethErrors.provider.userRejectedRequest())};this.queuedRequestController=new Y.QueuedRequestController({messenger:this.controllerMessenger.getRestricted({name:"QueuedRequestController",allowedActions:["NetworkController:getState","NetworkController:setActiveNetwork","SelectedNetworkController:getNetworkClientIdForDomain"],allowedEvents:["SelectedNetworkController:stateChange"]}),methodsRequiringNetworkSwitch:ee.methodsRequiringNetworkSwitch,clearPendingConfirmations:a}),this.approvalController=new N.ApprovalController({messenger:this.controllerMessenger.getRestricted({name:"ApprovalController"}),showApprovalRequest:e.showUserConfirmation,typesExcludedFromRateLimiting:[W.ApprovalType.EthSign,W.ApprovalType.PersonalSign,W.ApprovalType.EthSignTypedData,W.ApprovalType.Transaction,W.ApprovalType.WatchAsset,W.ApprovalType.EthGetEncryptionPublicKey,W.ApprovalType.EthDecrypt]});const l=this.controllerMessenger.getRestricted({name:"NetworkController"});let c={};o.NetworkController&&(c=o.NetworkController),this.networkController=new F.NetworkController({messenger:l,state:c,infuraProjectId:e.infuraProjectId,trackMetaMetricsEvent:(...e)=>this.metaMetricsController.trackEvent(...e)}),this.networkController.initializeProvider(),this.provider=this.networkController.getProviderAndBlockTracker().provider,this.blockTracker=this.networkController.getProviderAndBlockTracker().blockTracker,this.deprecatedNetworkVersions={};const d=this.controllerMessenger.getRestricted({name:"TokenListController",allowedEvents:["NetworkController:stateChange"]}),g=this.controllerMessenger.getRestricted({name:"PreferencesController",allowedActions:[],allowedEvents:[]});this.preferencesController=new je.default({initState:o.PreferencesController,initLangCode:e.initLangCode,messenger:g,provider:this.provider,networkConfigurations:this.networkController.state.networkConfigurations,onKeyringStateChange:e=>this.controllerMessenger.subscribe("KeyringController:stateChange",e)}),this.tokenListController=new s.TokenListController({chainId:this.networkController.state.providerConfig.chainId,preventPollingOnNetworkRestart:!ft(this,vt,Pt).call(this,this.preferencesController.store.getState()),messenger:d,state:o.TokenListController}),this.assetsContractController=new s.AssetsContractController({chainId:this.networkController.state.providerConfig.chainId,onPreferencesStateChange:e=>this.preferencesController.store.subscribe(e),onNetworkDidChange:e=>l.subscribe("NetworkController:networkDidChange",(()=>{const t=this.networkController.state;return e(t)})),getNetworkClientById:this.networkController.getNetworkClientById.bind(this.networkController)},{provider:this.provider},o.AssetsContractController);const C=this.controllerMessenger.getRestricted({name:"TokensController",allowedActions:["ApprovalController:addRequest","NetworkController:getNetworkClientById"],allowedEvents:["NetworkController:networkDidChange","AccountsController:selectedAccountChange","PreferencesController:stateChange","TokenListController:stateChange"]});this.tokensController=new s.TokensController({messenger:C,chainId:this.networkController.state.providerConfig.chainId,onPreferencesStateChange:e=>this.controllerMessenger.subscribe("AccountsController:selectedAccountChange",(t=>{e({selectedAddress:t.address})})),onNetworkDidChange:e=>l.subscribe("NetworkController:networkDidChange",(()=>{const t=this.networkController.state;return e(t)})),onTokenListStateChange:e=>this.controllerMessenger.subscribe(`${this.tokenListController.name}:stateChange`,e),getNetworkClientById:this.networkController.getNetworkClientById.bind(this.networkController),config:{provider:this.provider,selectedAddress:(null===(t=o.AccountsController)||void 0===t||null===(t=t.internalAccounts)||void 0===t||null===(t=t.accounts[null===(r=o.AccountsController)||void 0===r||null===(r=r.internalAccounts)||void 0===r?void 0:r.selectedAccount])||void 0===t?void 0:t.address)??""},state:o.TokensController}),this.controllerMessenger.registerActionHandler("TokensController:getState",(()=>this.tokensController.state));const v=this.controllerMessenger.getRestricted({name:"NftController",allowedActions:[`${this.approvalController.name}:addRequest`]});this.nftController=new s.NftController({messenger:v,chainId:this.networkController.state.providerConfig.chainId,onPreferencesStateChange:this.preferencesController.store.subscribe.bind(this.preferencesController.store),onNetworkStateChange:l.subscribe.bind(l,"NetworkController:stateChange"),getERC721AssetName:this.assetsContractController.getERC721AssetName.bind(this.assetsContractController),getERC721AssetSymbol:this.assetsContractController.getERC721AssetSymbol.bind(this.assetsContractController),getERC721TokenURI:this.assetsContractController.getERC721TokenURI.bind(this.assetsContractController),getERC721OwnerOf:this.assetsContractController.getERC721OwnerOf.bind(this.assetsContractController),getERC1155BalanceOf:this.assetsContractController.getERC1155BalanceOf.bind(this.assetsContractController),getERC1155TokenURI:this.assetsContractController.getERC1155TokenURI.bind(this.assetsContractController),onNftAdded:({address:e,symbol:t,tokenId:r,standard:n,source:o})=>this.metaMetricsController.trackEvent({event:he.MetaMetricsEventName.NftAdded,category:he.MetaMetricsEventCategory.Wallet,sensitiveProperties:{token_contract_address:e,token_symbol:t,token_id:r,token_standard:n,asset_type:te.AssetType.NFT,source:o}}),getNetworkClientById:this.networkController.getNetworkClientById.bind(this.networkController)},{},o.NftController),this.nftController.setApiKey(null),this.nftDetectionController=new s.NftDetectionController({chainId:this.networkController.state.providerConfig.chainId,onNftsStateChange:e=>this.nftController.subscribe(e),onPreferencesStateChange:this.preferencesController.store.subscribe.bind(this.preferencesController.store),onNetworkStateChange:l.subscribe.bind(l,"NetworkController:stateChange"),getOpenSeaApiKey:()=>this.nftController.openSeaApiKey,getBalancesInSingleCall:this.assetsContractController.getBalancesInSingleCall.bind(this.assetsContractController),addNft:this.nftController.addNft.bind(this.nftController),getNftApi:this.nftController.getNftApi.bind(this.nftController),getNftState:()=>this.nftController.state,disabled:this.preferencesController.store.getState().useNftDetection===undefined||!this.preferencesController.store.getState().useNftDetection,selectedAddress:this.preferencesController.store.getState().selectedAddress}),this.metaMetricsController=new Qe.default({segment:ze.segment,preferencesStore:this.preferencesController.store,onNetworkDidChange:l.subscribe.bind(l,"NetworkController:networkDidChange"),getNetworkIdentifier:()=>{const{type:e,rpcUrl:t}=this.networkController.state.providerConfig;return e===ne.NETWORK_TYPES.RPC?t:e},getCurrentChainId:()=>this.networkController.state.providerConfig.chainId,version:this.platform.getVersion(),environment:"production",extension:this.extension,initState:o.MetaMetricsController,captureException:T.captureException}),this.on("update",(e=>{this.metaMetricsController.handleMetaMaskStateUpdate(e)}));const A=this.controllerMessenger.getRestricted({name:"GasFeeController",allowedActions:["NetworkController:getEIP1559Compatibility","NetworkController:getNetworkClientById","NetworkController:getState"],allowedEvents:["NetworkController:stateChange"]});this.gasFeeController=new U.GasFeeController({state:o.GasFeeController,interval:1e4,messenger:A,clientId:re.SWAPS_CLIENT_ID,getProvider:()=>this.networkController.getProviderAndBlockTracker().provider,onNetworkDidChange:e=>{l.subscribe("NetworkController:networkDidChange",(()=>e(this.networkController.state)))},getCurrentNetworkEIP1559Compatibility:this.networkController.getEIP1559Compatibility.bind(this.networkController),getCurrentAccountEIP1559Compatibility:this.getCurrentAccountEIP1559Compatibility.bind(this),getCurrentNetworkLegacyGasAPICompatibility:()=>{const{chainId:e}=this.networkController.state.providerConfig;return e===ne.CHAIN_IDS.BSC},getChainId:()=>this.networkController.state.providerConfig.chainId,infuraAPIKey:e.infuraProjectId}),this.appStateController=new Ke.default({addUnlockListener:this.on.bind(this,"unlock"),isUnlocked:this.isUnlocked.bind(this),initState:o.AppStateController,onInactiveTimeout:()=>this.setLocked(),preferencesStore:this.preferencesController.store,messenger:this.controllerMessenger.getRestricted({name:"AppStateController",allowedActions:[`${this.approvalController.name}:addRequest`,`${this.approvalController.name}:acceptRequest`],allowedEvents:["KeyringController:qrKeyringStateChange"]}),extension:this.extension});const M=this.controllerMessenger.getRestricted({name:"CurrencyRateController",allowedActions:[`${this.networkController.name}:getNetworkClientById`]});this.currencyRateController=new s.CurrencyRateController({includeUsdRate:!0,messenger:M,state:o.CurrencyController});const G=this.controllerMessenger.getRestricted({name:"PhishingController"});this.phishingController=new I.PhishingController({messenger:G,state:o.PhishingController,hotlistRefreshInterval:undefined,stalelistRefreshInterval:undefined}),this.phishingController.maybeUpdateState(),this.ppomController=new H.PPOMController({messenger:this.controllerMessenger.getRestricted({name:"PPOMController",allowedEvents:["NetworkController:stateChange"]}),storageBackend:new ot.IndexedDBPPOMStorage("PPOMDB",1),provider:this.provider,ppomProvider:{PPOM:Ne.PPOM,ppomInit:Ne.default},state:o.PPOMController,chainId:this.networkController.state.providerConfig.chainId,securityAlertsEnabled:this.preferencesController.store.getState().securityAlertsEnabled,onPreferencesChange:this.preferencesController.store.subscribe.bind(this.preferencesController.store),cdnBaseUrl:"static.cx.metamask.io/api/v1/confirmations/ppom",blockaidPublicKey:"066ad3e8af5583385e312c156d238055215d5f25247c1e91055afa756cb98a88"});const Q=this.controllerMessenger.getRestricted({name:"AnnouncementController"});this.announcementController=new O.AnnouncementController({messenger:Q,allAnnouncements:le.UI_NOTIFICATIONS,state:o.AnnouncementController});const se=this.controllerMessenger.getRestricted({name:"NetworkOrderController",allowedEvents:["NetworkController:stateChange"]});this.networkOrderController=new De.NetworkOrderController({messenger:se,state:o.NetworkOrderController});const ie=this.controllerMessenger.getRestricted({name:"AccountOrderController"});this.accountOrderController=new xe.AccountOrderController({messenger:ie,state:o.AccountOrderController});const pe=this.controllerMessenger.getRestricted({name:"AccountsController",allowedEvents:["SnapController:stateChange","KeyringController:accountRemoved","KeyringController:stateChange","AccountsController:selectedAccountChange"],allowedActions:["AccountsController:setCurrentAccount","AccountsController:setAccountName","AccountsController:listAccounts","AccountsController:getSelectedAccount","AccountsController:getAccountByAddress","AccountsController:updateAccounts","KeyringController:getAccounts","KeyringController:getKeyringsByType","KeyringController:getKeyringForAccount"]});this.accountsController=new V.AccountsController({messenger:pe,state:o.AccountsController}),this.tokenRatesController=new s.TokenRatesController({chainId:this.networkController.state.providerConfig.chainId,ticker:this.networkController.state.providerConfig.ticker,selectedAddress:this.accountsController.getSelectedAccount().address,onTokensStateChange:e=>this.tokensController.subscribe(e),onNetworkStateChange:l.subscribe.bind(l,"NetworkController:stateChange"),onPreferencesStateChange:e=>this.controllerMessenger.subscribe("AccountsController:selectedAccountChange",(t=>{e({selectedAddress:t.address})})),tokenPricesService:new s.CodefiTokenPricesServiceV2,getNetworkClientById:this.networkController.getNetworkClientById.bind(this.networkController)},{allTokens:this.tokensController.state.allTokens,allDetectedTokens:this.tokensController.state.allDetectedTokens},o.TokenRatesController),this.preferencesController.store.subscribe((0,Je.previousValueComparator)(((e,t)=>{const{useCurrencyRateCheck:r}=e,{useCurrencyRateCheck:n}=t;n&&!r?this.tokenRatesController.start():!n&&r&&this.tokenRatesController.stop()}),this.preferencesController.store.getState())),this.ensController=new R.EnsController({messenger:this.controllerMessenger.getRestricted({name:"EnsController"}),provider:this.provider,onNetworkDidChange:l.subscribe.bind(l,"NetworkController:networkDidChange")}),this.onboardingController=new Ve.default({initState:o.OnboardingController});let ge=[(0,u.keyringBuilderFactory)(S.MetaMaskKeyring)];if(!1===we.isManifestV3){var Ce;const e=null===(Ce=this.opts.overrides)||void 0===Ce?void 0:Ce.keyrings,t=[(null==e?void 0:e.lattice)||y.default,S.MetaMaskKeyring],r=[{keyring:(null==e?void 0:e.trezor)||k.TrezorKeyring,bridge:(null==e?void 0:e.trezorBridge)||k.TrezorConnectBridge},{keyring:(null==e?void 0:e.ledger)||f.LedgerKeyring,bridge:(null==e?void 0:e.ledgerBridge)||f.LedgerIframeBridge}];ge=t.map((e=>(0,u.keyringBuilderFactory)(e))),r.forEach((e=>ge.push((0,Ze.hardwareKeyringBuilderFactory)(e.keyring,e.bridge))))}else ge.push((0,Ze.hardwareKeyringBuilderFactory)(k.TrezorKeyring,it.TrezorOffscreenBridge),(0,Ze.hardwareKeyringBuilderFactory)(f.LedgerKeyring,at.LedgerOffscreenBridge),(0,u.keyringBuilderFactory)(ht.LatticeKeyringOffscreen));const me=this.controllerMessenger.getRestricted({name:"SnapKeyringBuilder",allowedActions:["ApprovalController:addRequest","ApprovalController:acceptRequest","ApprovalController:rejectRequest","ApprovalController:startFlow","ApprovalController:endFlow","ApprovalController:showSuccess","ApprovalController:showError","PhishingController:test","PhishingController:maybeUpdateState","KeyringController:getAccounts","AccountsController:setSelectedAccount","AccountsController:getAccountByAddress"]});ge.push((0,lt.snapKeyringBuilder)(me,(()=>this.snapController),(async()=>{await this.keyringController.persistAllKeyrings(),await this.accountsController.updateAccounts()}),(e=>this.preferencesController.setSelectedAddress(e)),(e=>this.removeAccount(e)),this.metaMetricsController.trackEvent.bind(this.metaMetricsController),(e=>{if(!e)return null;const t=this.getLocale(),{snaps:r}=this.snapController.state,n=r[e];if(!n)return(0,Z.stripSnapPrefix)(e);if(n.localizationFiles){return(0,Z.getLocalizedSnapManifest)(n.manifest,t,n.localizationFiles).proposedName}return n.manifest.proposedName})));const be=this.controllerMessenger.getRestricted({name:"KeyringController"});this.keyringController=new p.KeyringController({cacheEncryptionKey:!0,keyringBuilders:ge,state:o.KeyringController,encryptor:e.encryptor||(0,ct.encryptorFactory)(6e5),messenger:be,removeIdentity:this.preferencesController.removeAddress.bind(this.preferencesController),setAccountLabel:(e,t)=>{const r=this.accountsController.getAccountByAddress(e);if(r===undefined)throw new Error(`No account found for address: ${e}`);this.accountsController.setAccountName(r.id,t),this.preferencesController.setAccountLabel(e,t)},setSelectedAddress:e=>{const t=this.accountsController.getAccountByAddress(e);if(t===undefined)throw new Error(`No account found for address: ${e}`);this.accountsController.setSelectedAccount(t.id),this.preferencesController.setSelectedAddress(e)},syncIdentities:e=>{this.preferencesController.syncAddresses(e)},updateIdentities:this.preferencesController.setAddresses.bind(this.preferencesController)}),this.controllerMessenger.subscribe("KeyringController:unlock",(()=>this._onUnlock())),this.controllerMessenger.subscribe("KeyringController:lock",(()=>this._onLock())),this.controllerMessenger.subscribe("KeyringController:stateChange",(e=>{this._onKeyringControllerUpdate(e)})),this.permissionController=new L.PermissionController({messenger:this.controllerMessenger.getRestricted({name:"PermissionController",allowedActions:[`${this.approvalController.name}:addRequest`,`${this.approvalController.name}:hasRequest`,`${this.approvalController.name}:acceptRequest`,`${this.approvalController.name}:rejectRequest`,"SnapController:getPermitted","SnapController:install","SubjectMetadataController:getSubjectMetadata"]}),state:o.PermissionController,caveatSpecifications:(0,rt.getCaveatSpecifications)({getInternalAccounts:this.accountsController.listAccounts.bind(this.accountsController)}),permissionSpecifications:{...(0,rt.getPermissionSpecifications)({getInternalAccounts:this.accountsController.listAccounts.bind(this.accountsController),getAllAccounts:this.keyringController.getAccounts.bind(this.keyringController),captureKeyringTypesWithMissingIdentities:(e=[],t=[])=>{const r=t.filter((t=>!e.some((e=>e.address.toLowerCase()===t.toLowerCase())))).map((e=>this.keyringController.getAccountKeyringType(e))),n=e.length,o=Object.keys(this.accountTracker.store.getState().accounts||{}).length;(0,T.captureException)(new Error(`Attempt to get permission specifications failed because their were ${t.length} accounts, but ${n} identities, and the ${r} keyrings included accounts with missing identities. Meanwhile, there are ${o} accounts in the account tracker.`))}}),...this.getSnapPermissionSpecifications()},unrestrictedMethods:rt.unrestrictedMethods}),this.selectedNetworkController=new D.SelectedNetworkController({messenger:this.controllerMessenger.getRestricted({name:"SelectedNetworkController",allowedActions:["NetworkController:getNetworkClientById","NetworkController:getState","NetworkController:getSelectedNetworkClient","PermissionController:hasPermissions","PermissionController:getSubjectNames"],allowedEvents:["NetworkController:stateChange","PermissionController:stateChange"]}),state:o.SelectedNetworkController,useRequestQueuePreference:this.preferencesController.store.getState().useRequestQueue,onPreferencesStateChange:e=>this.preferencesController.store.subscribe(e),domainProxyMap:new Ct.WeakRefObjectMap}),this.permissionLogController=new B.PermissionLogController({messenger:this.controllerMessenger.getRestricted({name:"PermissionLogController"}),restrictedMethods:new Set(Object.keys(ae.RestrictedMethods)),state:o.PermissionLogController}),this.subjectMetadataController=new L.SubjectMetadataController({messenger:this.controllerMessenger.getRestricted({name:"SubjectMetadataController",allowedActions:[`${this.permissionController.name}:hasPermissions`]}),state:o.SubjectMetadataController,subjectCacheLimit:100});const ke=we.isManifestV3&&"undefined"!=typeof chrome&&void 0!==chrome.offscreen,ye={messenger:this.controllerMessenger.getRestricted({name:"ExecutionService"}),setupSnapProvider:this.setupSnapProvider.bind(this)};this.snapExecutionService=!1===ke?new K.IframeExecutionService({...ye,iframeUrl:new URL("https://execution.metamask.io/iframe/6.0.2/index.html")}):new K.OffscreenExecutionService({documentUrl:chrome.runtime.getURL("./offscreen.html"),...ye});const Se=this.controllerMessenger.getRestricted({name:"SnapController",allowedEvents:["ExecutionService:unhandledError","ExecutionService:outboundRequest","ExecutionService:outboundResponse"],allowedActions:[`${this.permissionController.name}:getEndowments`,`${this.permissionController.name}:getPermissions`,`${this.permissionController.name}:hasPermission`,`${this.permissionController.name}:hasPermissions`,`${this.permissionController.name}:requestPermissions`,`${this.permissionController.name}:revokeAllPermissions`,`${this.permissionController.name}:revokePermissions`,`${this.permissionController.name}:revokePermissionForAllSubjects`,`${this.permissionController.name}:getSubjectNames`,`${this.permissionController.name}:updateCaveat`,`${this.approvalController.name}:addRequest`,`${this.approvalController.name}:updateRequestState`,`${this.permissionController.name}:grantPermissions`,`${this.subjectMetadataController.name}:getSubjectMetadata`,`${this.subjectMetadataController.name}:addSubjectMetadata`,"ExecutionService:executeSnap","ExecutionService:getRpcRequestHandler","ExecutionService:terminateSnap","ExecutionService:terminateAllSnaps","ExecutionService:handleRpcRequest","SnapsRegistry:get","SnapsRegistry:getMetadata","SnapsRegistry:update","SnapsRegistry:resolveVersion","SnapInterfaceController:createInterface","SnapInterfaceController:getInterface"]}),ve=!0;this.snapController=new K.SnapController({environmentEndowmentPermissions:Object.values(ae.EndowmentPermissions),excludedPermissions:{...ae.ExcludedSnapPermissions,...ae.ExcludedSnapEndowments},closeAllConnections:this.removeAllConnections.bind(this),state:o.SnapController,messenger:Se,featureFlags:{dappsCanUpdateSnaps:!0,allowLocalSnaps:!1,requireAllowlist:ve},encryptor:(0,ct.encryptorFactory)(6e5),getMnemonic:this.getPrimaryKeyringMnemonic.bind(this),preinstalledSnaps:ut.default}),this.notificationController=new j.NotificationController({messenger:this.controllerMessenger.getRestricted({name:"NotificationController"}),state:o.NotificationController}),this.rateLimitController=new q.RateLimitController({state:o.RateLimitController,messenger:this.controllerMessenger.getRestricted({name:"RateLimitController"}),implementations:{showNativeNotification:{method:(e,t)=>{const r=this.controllerMessenger.call("SubjectMetadataController:getState").subjectMetadata[e];return this.platform._showNotification((null==r?void 0:r.name)??e,t).catch((e=>{w.default.error("Failed to create notification",e)})),null},rateLimitCount:2,rateLimitTimeout:3e5},showInAppNotification:{method:(e,t)=>(this.controllerMessenger.call("NotificationController:show",e,t),null),rateLimitCount:5,rateLimitTimeout:6e4}}});const Pe=this.controllerMessenger.getRestricted({name:"CronjobController",allowedEvents:["SnapController:snapInstalled","SnapController:snapUpdated","SnapController:snapUninstalled","SnapController:snapEnabled","SnapController:snapDisabled"],allowedActions:[`${this.permissionController.name}:getPermissions`,"SnapController:handleRequest","SnapController:getAll"]});this.cronjobController=new K.CronjobController({state:o.CronjobController,messenger:Pe});const Oe=this.controllerMessenger.getRestricted({name:"SnapsRegistry",allowedEvents:[],allowedActions:[]});this.snapsRegistry=new K.JsonSnapsRegistry({state:o.SnapsRegistry,messenger:Oe,refetchOnAllowlistMiss:ve,failOnUnavailableRegistry:ve,url:{registry:"https://acl.execution.metamask.io/latest/registry.json",signature:"https://acl.execution.metamask.io/latest/signature.json"},publicKey:"0x025b65308f0f0fb8bc7f7ff87bfc296e0330eee5d3c1d1ee4a048b2fd6a86fa0a6"});const Fe=this.controllerMessenger.getRestricted({name:"SnapInterfaceController",allowedActions:[`${this.phishingController.name}:maybeUpdateState`,`${this.phishingController.name}:testOrigin`]});this.snapInterfaceController=new K.SnapInterfaceController({state:o.SnapInterfaceController,messenger:Fe}),this.authenticationController=new pt.default({state:o.AuthenticationController,messenger:this.controllerMessenger.getRestricted({name:"AuthenticationController",allowedActions:["SnapController:handleRequest"]})}),this.userStorageController=new gt.default({state:o.UserStorageController,messenger:this.controllerMessenger.getRestricted({name:"UserStorageController",allowedActions:["SnapController:handleRequest","AuthenticationController:getBearerToken","AuthenticationController:getSessionProfile","AuthenticationController:isSignedIn","AuthenticationController:performSignIn"]})}),this.accountTracker=new Ie.default({provider:this.provider,blockTracker:this.blockTracker,getCurrentChainId:()=>this.networkController.state.providerConfig.chainId,getNetworkIdentifier:e=>{const{type:t,rpcUrl:r}=e??this.networkController.state.providerConfig;return t===ne.NETWORK_TYPES.RPC?r:t},preferencesController:this.preferencesController,onboardingController:this.onboardingController,controllerMessenger:this.controllerMessenger.getRestricted({name:"AccountTracker",allowedEvents:["AccountsController:selectedAccountChange"],allowedActions:["AccountsController:getSelectedAccount"]}),initState:{accounts:{}},onAccountRemoved:this.controllerMessenger.subscribe.bind(this.controllerMessenger,"KeyringController:accountRemoved")}),this.on("controllerConnectionChanged",(e=>{const{completedOnboarding:t}=this.onboardingController.store.getState();e>0&&t?this.triggerNetworkrequests():this.stopNetworkRequests()})),this.onboardingController.store.subscribe((0,Je.previousValueComparator)((async(e,t)=>{const{completedOnboarding:r}=e,{completedOnboarding:n}=t;if(!r&&n){const{address:e}=this.accountsController.getSelectedAccount();this.postOnboardingInitialization(),this.triggerNetworkrequests(),await this.tokenDetectionController.detectTokens({selectedAddress:e})}}),this.onboardingController.store.getState()));const Ue=this.controllerMessenger.getRestricted({name:"TokenDetectionController",allowedActions:["AccountsController:getSelectedAccount","KeyringController:getState","NetworkController:getNetworkClientById","NetworkController:getNetworkConfigurationByNetworkClientId","NetworkController:getState","PreferencesController:getState","TokenListController:getState","TokensController:getState","TokensController:addDetectedTokens"],allowedEvents:["AccountsController:selectedAccountChange","KeyringController:lock","KeyringController:unlock","NetworkController:networkDidChange","PreferencesController:stateChange","TokenListController:stateChange"]});this.tokenDetectionController=new s.TokenDetectionController({messenger:Ue,getBalancesInSingleCall:this.assetsContractController.getBalancesInSingleCall.bind(this.assetsContractController),trackMetaMetricsEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController)}),this.addressBookController=new P.AddressBookController(undefined,o.AddressBookController),this.alertController=new Ge.default({initState:o.AlertController,preferencesStore:this.preferencesController.store,controllerMessenger:this.controllerMessenger.getRestricted({name:"AlertController",allowedEvents:["AccountsController:selectedAccountChange"],allowedActions:["AccountsController:getSelectedAccount"]})}),this.backup=new $e.default({preferencesController:this.preferencesController,addressBookController:this.addressBookController,accountsController:this.accountsController,networkController:this.networkController,trackMetaMetricsEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController)}),this.snapAndHardwareMetricsParams={getSelectedAccount:this.accountsController.getSelectedAccount.bind(this.accountsController),getAccountType:this.getAccountType.bind(this),getDeviceModel:this.getDeviceModel.bind(this),snapAndHardwareMessenger:this.controllerMessenger.getRestricted({name:"SnapAndHardwareMessenger",allowedActions:["KeyringController:getKeyringForAccount","SnapController:get","AccountsController:getSelectedAccount"]})};const Le=this.controllerMessenger.getRestricted({name:"TransactionController",allowedActions:[`${this.approvalController.name}:addRequest`,"NetworkController:findNetworkClientIdByChainId","NetworkController:getNetworkClientById"],allowedEvents:["NetworkController:stateChange"]});this.txController=new X.TransactionController({blockTracker:this.blockTracker,getCurrentNetworkEIP1559Compatibility:this.networkController.getEIP1559Compatibility.bind(this.networkController),getCurrentAccountEIP1559Compatibility:this.getCurrentAccountEIP1559Compatibility.bind(this),getExternalPendingTransactions:this.getExternalPendingTransactions.bind(this),getGasFeeEstimates:this.gasFeeController.fetchGasFeeEstimates.bind(this.gasFeeController),getNetworkClientRegistry:this.networkController.getNetworkClientRegistry.bind(this.networkController),getNetworkState:()=>this.networkController.state,getPermittedAccounts:this.getPermittedAccounts.bind(this),getSavedGasFees:()=>this.preferencesController.store.getState().advancedGasFee[this.networkController.state.providerConfig.chainId],getSelectedAddress:()=>this.accountsController.getSelectedAccount().address,incomingTransactions:{includeTokenTransfers:!1,isEnabled:()=>{var e;return Boolean((null===(e=this.preferencesController.store.getState().incomingTransactionsPreferences)||void 0===e?void 0:e[this.networkController.state.providerConfig.chainId])&&this.onboardingController.store.getState().completedOnboarding)},queryEntireHistory:!1,updateTransactions:!1},isMultichainEnabled:"",isSimulationEnabled:()=>this.preferencesController.store.getState().useTransactionSimulations,messenger:Le,onNetworkStateChange:e=>{l.subscribe("NetworkController:networkDidChange",(()=>e()))},pendingTransactions:{isResubmitEnabled:()=>{const e=this._getMetaMaskState();return!((0,fe.getSmartTransactionsOptInStatus)(e)&&(0,fe.getCurrentChainSupportsSmartTransactions)(e))}},provider:this.provider,hooks:{publish:this._publishSmartTransactionHook.bind(this)},sign:(...e)=>this.keyringController.signTransaction(...e),state:o.TransactionController}),this._addTransactionControllerListeners(),this.decryptMessageController=new He.default({getState:this.getState.bind(this),messenger:this.controllerMessenger.getRestricted({name:"DecryptMessageController",allowedActions:[`${this.approvalController.name}:addRequest`,`${this.approvalController.name}:acceptRequest`,`${this.approvalController.name}:rejectRequest`,`${this.keyringController.name}:decryptMessage`]}),metricsEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController)}),this.encryptionPublicKeyController=new et.default({messenger:this.controllerMessenger.getRestricted({name:"EncryptionPublicKeyController",allowedActions:[`${this.approvalController.name}:addRequest`,`${this.approvalController.name}:acceptRequest`,`${this.approvalController.name}:rejectRequest`]}),getEncryptionPublicKey:this.keyringController.getEncryptionPublicKey.bind(this.keyringController),getAccountKeyringType:this.keyringController.getAccountKeyringType.bind(this.keyringController),getState:this.getState.bind(this),metricsEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController)}),this.signatureController=new $.SignatureController({messenger:this.controllerMessenger.getRestricted({name:"SignatureController",allowedActions:[`${this.approvalController.name}:addRequest`,`${this.keyringController.name}:signMessage`,`${this.keyringController.name}:signPersonalMessage`,`${this.keyringController.name}:signTypedMessage`,`${this.loggingController.name}:add`]}),isEthSignEnabled:()=>{var e;return null===(e=this.preferencesController.store.getState())||void 0===e||null===(e=e.disabledRpcMethodPreferences)||void 0===e?void 0:e.eth_sign},getAllState:this.getState.bind(this),getCurrentChainId:()=>this.networkController.state.providerConfig.chainId}),this.signatureController.hub.on("cancelWithReason",(({message:e,reason:t})=>{this.metaMetricsController.trackEvent({event:t,category:he.MetaMetricsEventCategory.Transactions,properties:{action:"Sign Request",type:e.type}})})),this.swapsController=new We.default({getBufferedGasLimit:async(e,t)=>{const{gas:r,simulationFails:n}=await this.txController.estimateGasBuffered(e.txParams,t);return{gasLimit:r,simulationFails:n}},provider:this.provider,getProviderConfig:()=>this.networkController.state.providerConfig,getTokenRatesState:()=>this.tokenRatesController.state,getCurrentChainId:()=>this.networkController.state.providerConfig.chainId,getEIP1559GasFeeEstimates:this.gasFeeController.fetchGasFeeEstimates.bind(this.gasFeeController),getLayer1GasFee:this.txController.getLayer1GasFee.bind(this.txController),getNetworkClientId:()=>this.networkController.state.selectedNetworkClientId,trackMetaMetricsEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController)},o.SwapsController),this.smartTransactionsController=new _.default({getNetworkClientById:this.networkController.getNetworkClientById.bind(this.networkController),onNetworkStateChange:l.subscribe.bind(l,"NetworkController:stateChange"),getNonceLock:this.txController.getNonceLock.bind(this.txController),confirmExternalTransaction:this.txController.confirmExternalTransaction.bind(this.txController),getTransactions:this.txController.getTransactions.bind(this.txController),provider:this.provider,trackMetaMetricsEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController)},{supportedChainIds:(0,oe.getAllowedSmartTransactionsChainIds)()},o.SmartTransactionsController);const _e=()=>this.preferencesController.store.getState().useExternalNameSources;this.nameController=new z.NameController({messenger:this.controllerMessenger.getRestricted({name:"NameController",allowedActions:[]}),providers:[new z.ENSNameProvider({reverseLookup:this.ensController.reverseResolveAddress.bind(this.ensController)}),new z.EtherscanNameProvider({isEnabled:_e}),new z.TokenNameProvider({isEnabled:_e}),new z.LensNameProvider({isEnabled:_e}),new Ae.SnapsNameProvider({messenger:this.controllerMessenger.getRestricted({name:"SnapsNameProvider",allowedActions:["SnapController:getAll","SnapController:get","SnapController:handleRequest","PermissionController:getState"]})})],state:o.NameController});const Be=this.controllerMessenger.getRestricted({name:"PetnamesBridge",allowedEvents:["NameController:stateChange","AccountsController:stateChange"],allowedActions:["AccountsController:listAccounts"]});new Me.AddressBookPetnamesBridge({addressBookController:this.addressBookController,nameController:this.nameController,messenger:Be}).init(),new Te.AccountIdentitiesPetnamesBridge({nameController:this.nameController,messenger:Be}).init(),this.userOperationController=new J.UserOperationController({entrypoint:null,getGasFeeEstimates:this.gasFeeController.fetchGasFeeEstimates.bind(this.gasFeeController),messenger:this.controllerMessenger.getRestricted({name:"UserOperationController",allowedActions:["ApprovalController:addRequest","NetworkController:getNetworkClientById","KeyringController:prepareUserOperation","KeyringController:patchUserOperation","KeyringController:signUserOperation"]}),state:o.UserOperationController}),this.userOperationController.hub.on("user-operation-added",this._onUserOperationAdded.bind(this)),this.userOperationController.hub.on("transaction-updated",this._onUserOperationTransactionUpdated.bind(this)),l.subscribe("NetworkController:networkDidChange",(()=>{this.accountTracker.updateAccounts()})),l.subscribe("NetworkController:networkWillChange",a.bind(this)),this.metamaskMiddleware=(0,Xe.default)({static:{eth_syncing:!1,web3_clientVersion:`MetaMask/v${i}`},version:i,getAccounts:async({origin:e},{suppressUnauthorizedError:t=!0}={})=>{if(e===de.ORIGIN_METAMASK){const e=this.accountsController.getSelectedAccount().address;return e?[e]:[]}return this.isUnlocked()?await this.getPermittedAccounts(e,{suppressUnauthorizedError:t}):[]},processTransaction:(e,t)=>(0,dt.addDappTransaction)(this.getAddTransactionRequest({transactionParams:e,dappRequest:t})),processEthSignMessage:this.signatureController.newUnsignedMessage.bind(this.signatureController),processTypedMessage:this.signatureController.newUnsignedTypedMessage.bind(this.signatureController),processTypedMessageV3:this.signatureController.newUnsignedTypedMessage.bind(this.signatureController),processTypedMessageV4:this.signatureController.newUnsignedTypedMessage.bind(this.signatureController),processPersonalMessage:this.signatureController.newUnsignedPersonalMessage.bind(this.signatureController),processEncryptionPublicKey:this.encryptionPublicKeyController.newRequestEncryptionPublicKey.bind(this.encryptionPublicKeyController),processDecryptMessage:this.decryptMessageController.newRequestDecryptMessage.bind(this.decryptMessageController),getPendingNonce:this.getPendingNonce.bind(this),getPendingTransactionByHash:e=>this.txController.state.transactions.find((t=>t.hash===e&&t.status===X.TransactionStatus.submitted))}),this.on("update",(e=>this._onStateUpdate(e)));const qe={AccountTracker:this.accountTracker.store,TokenRatesController:this.tokenRatesController,DecryptMessageController:this.decryptMessageController,EncryptionPublicKeyController:this.encryptionPublicKeyController,SignatureController:this.signatureController,SwapsController:this.swapsController.store,EnsController:this.ensController,ApprovalController:this.approvalController,PPOMController:this.ppomController};this.store.updateStructure({AccountsController:this.accountsController,AppStateController:this.appStateController.store,AppMetadataController:this.appMetadataController.store,TransactionController:this.txController,KeyringController:this.keyringController,PreferencesController:this.preferencesController.store,MetaMetricsController:this.metaMetricsController.store,AddressBookController:this.addressBookController,CurrencyController:this.currencyRateController,NetworkController:this.networkController,AlertController:this.alertController.store,OnboardingController:this.onboardingController.store,PermissionController:this.permissionController,PermissionLogController:this.permissionLogController,SubjectMetadataController:this.subjectMetadataController,AnnouncementController:this.announcementController,NetworkOrderController:this.networkOrderController,AccountOrderController:this.accountOrderController,GasFeeController:this.gasFeeController,TokenListController:this.tokenListController,TokensController:this.tokensController,SmartTransactionsController:this.smartTransactionsController,NftController:this.nftController,PhishingController:this.phishingController,SelectedNetworkController:this.selectedNetworkController,LoggingController:this.loggingController,SnapController:this.snapController,CronjobController:this.cronjobController,SnapsRegistry:this.snapsRegistry,NotificationController:this.notificationController,SnapInterfaceController:this.snapInterfaceController,PPOMController:this.ppomController,NameController:this.nameController,UserOperationController:this.userOperationController,...qe}),this.memStore=new Re.default({config:{AccountsController:this.accountsController,AppStateController:this.appStateController.store,AppMetadataController:this.appMetadataController.store,NetworkController:this.networkController,KeyringController:this.keyringController,PreferencesController:this.preferencesController.store,MetaMetricsController:this.metaMetricsController.store,AddressBookController:this.addressBookController,CurrencyController:this.currencyRateController,AlertController:this.alertController.store,OnboardingController:this.onboardingController.store,PermissionController:this.permissionController,PermissionLogController:this.permissionLogController,SubjectMetadataController:this.subjectMetadataController,AnnouncementController:this.announcementController,NetworkOrderController:this.networkOrderController,AccountOrderController:this.accountOrderController,GasFeeController:this.gasFeeController,TokenListController:this.tokenListController,TokensController:this.tokensController,SmartTransactionsController:this.smartTransactionsController,NftController:this.nftController,SelectedNetworkController:this.selectedNetworkController,LoggingController:this.loggingController,TxController:this.txController,SnapController:this.snapController,CronjobController:this.cronjobController,SnapsRegistry:this.snapsRegistry,NotificationController:this.notificationController,SnapInterfaceController:this.snapInterfaceController,NameController:this.nameController,UserOperationController:this.userOperationController,...qe},controllerMessenger:this.controllerMessenger});const Ye=[this.accountTracker.resetState,this.decryptMessageController.resetState.bind(this.decryptMessageController),this.encryptionPublicKeyController.resetState.bind(this.encryptionPublicKeyController),this.signatureController.resetState.bind(this.signatureController),this.swapsController.resetState,this.ensController.resetState.bind(this.ensController),this.approvalController.clear.bind(this.approvalController)];we.isManifestV3?!0===n&&(this.resetStates(Ye),this.extension.storage.session.set({isFirstMetaMaskControllerSetup:!1})):this.resetStates(Ye);!this.isUnlocked()&&this.onboardingController.store.getState().completedOnboarding,this._startUISync(),this.extension.runtime.getPlatformInfo().then((({os:e})=>{this.appStateController.setBrowserEnvironment(e,this.extension.runtime.getBrowserInfo===undefined?"chrome":"firefox")})),this.setupControllerEventSubscriptions(),this.publicConfigStore=this.createPublicConfigStore(),this.extension.runtime.onMessageExternal.addListener(Ee.onMessageReceived),(0,Ee.checkForMultipleVersionsRunning)(),this.onboardingController.store.getState().completedOnboarding&&this.postOnboardingInitialization()}postOnboardingInitialization(){this.networkController.lookupNetwork()}triggerNetworkrequests(){this.accountTracker.start(),this.txController.startIncomingTransactionPolling(),this.tokenDetectionController.enable();const e=this.preferencesController.store.getState(),{useCurrencyRateCheck:t,useNftDetection:r}=e;r&&this.nftDetectionController.start(),t&&this.tokenRatesController.start(),ft(this,vt,Pt).call(this,e)&&this.tokenListController.start()}stopNetworkRequests(){this.accountTracker.stop(),this.txController.stopIncomingTransactionPolling(),this.tokenDetectionController.disable(),this.nftDetectionController.stop();const e=this.preferencesController.store.getState(),{useCurrencyRateCheck:t}=e;t&&this.tokenRatesController.stop(),ft(this,vt,Pt).call(this,e)&&this.tokenListController.stop()}resetStates(e){e.forEach((e=>{try{e()}catch(e){console.error(e)}}))}async getSnapKeyring(){let[e]=this.keyringController.getKeyringsByType(ie.KeyringType.snap);return e||(e=await this.keyringController.addNewKeyring(ie.KeyringType.snap)),e}_getSnapMetadata(e){var t;return null===(t=this.snapsRegistry.state.database)||void 0===t||null===(t=t.verifiedSnaps)||void 0===t||null===(t=t[e])||void 0===t?void 0:t.metadata}async handleSnapRequest(e){try{const t=await this.controllerMessenger.call("SnapController:handleRequest",e);return this._trackSnapExportUsage(e.snapId,e.handler,!0,e.origin),t}catch(t){throw this._trackSnapExportUsage(e.snapId,e.handler,!1,e.origin),t}}getLocale(){const{currentLocale:e}=this.preferencesController.store.getState();return e}getSnapPermissionSpecifications(){return{...(0,G.buildSnapEndowmentSpecifications)(Object.keys(ae.ExcludedSnapEndowments)),...(0,G.buildSnapRestrictedMethodSpecifications)(Object.keys(ae.ExcludedSnapPermissions),{getLocale:this.getLocale.bind(this),clearSnapState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:clearSnapState"),getMnemonic:this.getPrimaryKeyringMnemonic.bind(this),getUnlockPromise:this.appStateController.getUnlockPromise.bind(this.appStateController),getSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:get"),handleSnapRpcRequest:this.handleSnapRequest.bind(this),getSnapState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getSnapState"),showDialog:(e,t,r,n)=>this.approvalController.addAndShowApprovalRequest({origin:e,type:de.SNAP_DIALOG_TYPES[t],requestData:{id:r,placeholder:n}}),showNativeNotification:(e,t)=>this.controllerMessenger.call("RateLimitController:call",e,"showNativeNotification",e,t.message),showInAppNotification:(e,t)=>this.controllerMessenger.call("RateLimitController:call",e,"showInAppNotification",e,t.message),updateSnapState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:updateSnapState"),maybeUpdatePhishingList:()=>{const{usePhishDetect:e}=this.preferencesController.store.getState();e&&this.controllerMessenger.call("PhishingController:maybeUpdateState")},isOnPhishingList:e=>{const{usePhishDetect:t}=this.preferencesController.store.getState();return!!t&&this.controllerMessenger.call("PhishingController:testOrigin",e).result},createInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:createInterface"),getInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:getInterface"),getSnapKeyring:this.getSnapKeyring.bind(this)})}}dismissNotifications(e){this.notificationController.dismiss(e)}markNotificationsAsRead(e){this.notificationController.markRead(e)}setupControllerEventSubscriptions(){let e;this.preferencesController.store.subscribe((0,Je.previousValueComparator)(((e,t)=>{ft(this,yt,Mt).call(this,t,e)}),this.preferencesController.store.getState())),this.controllerMessenger.subscribe(`${this.accountsController.name}:selectedAccountChange`,(async t=>{t.address&&t.address!==e&&(e=t.address,await this._onAccountChange(t.address))})),this.controllerMessenger.subscribe(`${this.permissionController.name}:stateChange`,(async(e,t)=>{const r=(0,rt.getChangedAccounts)(e,t);for(const[e,t]of r.entries())this._notifyAccountsChange(e,t)}),rt.getPermittedAccountsByOrigin),this.controllerMessenger.subscribe("NetworkController:networkDidChange",(async()=>{await this.txController.updateIncomingTransactions()})),this.controllerMessenger.subscribe(`${this.snapController.name}:snapInstallStarted`,((e,t,r)=>{var n;const o=null===(n=this._getSnapMetadata(e))||void 0===n?void 0:n.category;this.metaMetricsController.trackEvent({event:r?he.MetaMetricsEventName.SnapUpdateStarted:he.MetaMetricsEventName.SnapInstallStarted,category:he.MetaMetricsEventCategory.Snaps,properties:{snap_id:e,origin:t,snap_category:o}})})),this.controllerMessenger.subscribe(`${this.snapController.name}:snapInstallFailed`,((e,t,r,n)=>{var o;const s=n.includes("User rejected the request."),i=r?he.MetaMetricsEventName.SnapUpdateFailed:he.MetaMetricsEventName.SnapInstallFailed,a=r?he.MetaMetricsEventName.SnapUpdateRejected:he.MetaMetricsEventName.SnapInstallRejected,l=null===(o=this._getSnapMetadata(e))||void 0===o?void 0:o.category;this.metaMetricsController.trackEvent({event:s?a:i,category:he.MetaMetricsEventCategory.Snaps,properties:{snap_id:e,origin:t,snap_category:l}})})),this.controllerMessenger.subscribe(`${this.snapController.name}:snapInstalled`,((e,t)=>{var r;const n=e.id,o=null===(r=this._getSnapMetadata(n))||void 0===r?void 0:r.category;this.metaMetricsController.trackEvent({event:he.MetaMetricsEventName.SnapInstalled,category:he.MetaMetricsEventCategory.Snaps,properties:{snap_id:n,version:e.version,origin:t,snap_category:o}})})),this.controllerMessenger.subscribe(`${this.snapController.name}:snapUpdated`,((e,t,r)=>{var n;const o=e.id,s=null===(n=this._getSnapMetadata(o))||void 0===n?void 0:n.category;this.metaMetricsController.trackEvent({event:he.MetaMetricsEventName.SnapUpdated,category:he.MetaMetricsEventCategory.Snaps,properties:{snap_id:o,old_version:t,new_version:e.version,origin:r,snap_category:s}})})),this.controllerMessenger.subscribe(`${this.snapController.name}:snapTerminated`,(e=>{const t=Object.values(this.approvalController.state.pendingApprovals).filter((t=>t.origin===e.id&&t.type.startsWith(ae.RestrictedMethods.snap_dialog)));for(const e of t)this.approvalController.reject(e.id,new Error("Snap was terminated."))})),this.controllerMessenger.subscribe(`${this.snapController.name}:snapUninstalled`,(e=>{var t;const r=Object.values(this.notificationController.state.notifications).reduce(((t,r)=>(r.origin===e.id&&t.push(r.id),t)),[]);this.dismissNotifications(r);const n=e.id,o=null===(t=this._getSnapMetadata(n))||void 0===t?void 0:t.category;this.metaMetricsController.trackEvent({event:he.MetaMetricsEventName.SnapUninstalled,category:he.MetaMetricsEventCategory.Snaps,properties:{snap_id:n,version:e.version,snap_category:o}})}))}createPublicConfigStore(){const e=new i.ObservableStore,t=async({isUnlocked:e})=>{const{chainId:t,networkVersion:r}=await this.getProviderNetworkState();return{isUnlocked:e,chainId:t,networkVersion:r??"loading"}},r=async r=>{var n;(null===(n=r.networksMetadata[r.selectedNetworkClientId])||void 0===n?void 0:n.status)===ne.NetworkStatus.Available&&e.putState(await t(r))};return this.on("update",r),r(this.getState()),e}async getProviderState(e){const t=await this.getProviderNetworkState(this.preferencesController.getUseRequestQueue()?e:undefined);return{isUnlocked:this.isUnlocked(),accounts:await this.getPermittedAccounts(e),...t}}async getProviderNetworkState(e=D.METAMASK_DOMAIN){const t=this.controllerMessenger.call("SelectedNetworkController:getNetworkClientIdForDomain",e),r=this.controllerMessenger.call("NetworkController:getNetworkClientById",t),{chainId:n}=r.configuration,{completedOnboarding:o}=this.onboardingController.store.getState();let s=this.deprecatedNetworkVersions[t];if(!s&&o){const e=new v.default(r.provider);s=await new Promise((t=>{e.sendAsync({method:"net_version"},((e,r)=>{e?(console.error(e),t(null)):t((0,ke.convertNetworkId)(r))}))})),this.deprecatedNetworkVersions[t]=s}return{chainId:n,networkVersion:s??"loading"}}getState(){const{vault:e}=this.keyringController.state,t=Boolean(e),r=this.memStore.getFlatState();return delete r.vault,{isInitialized:t,...r,snapStates:{},unencryptedSnapStates:{},snaps:Object.values(r.snaps??{}).reduce(((e,t)=>{const{sourceCode:r,auxiliaryFiles:n,...o}=t;return e[t.id]=o,e}),{})}}getApi(){const{accountsController:e,addressBookController:t,alertController:r,appStateController:n,keyringController:o,nftController:s,nftDetectionController:i,currencyRateController:a,tokenDetectionController:l,ensController:c,gasFeeController:d,metaMetricsController:h,networkController:u,announcementController:p,onboardingController:g,permissionController:C,preferencesController:m,swapsController:b,tokensController:w,smartTransactionsController:k,txController:f,assetsContractController:y,backup:S,approvalController:v,phishingController:A}=this;return{getState:this.getState.bind(this),setCurrentCurrency:a.setCurrentCurrency.bind(a),setUseBlockie:m.setUseBlockie.bind(m),setUseNonceField:m.setUseNonceField.bind(m),setUsePhishDetect:m.setUsePhishDetect.bind(m),setUseMultiAccountBalanceChecker:m.setUseMultiAccountBalanceChecker.bind(m),dismissOpenSeaToBlockaidBanner:m.dismissOpenSeaToBlockaidBanner.bind(m),setUseSafeChainsListValidation:m.setUseSafeChainsListValidation.bind(m),setUseTokenDetection:m.setUseTokenDetection.bind(m),setUseNftDetection:m.setUseNftDetection.bind(m),setUse4ByteResolution:m.setUse4ByteResolution.bind(m),setUseCurrencyRateCheck:m.setUseCurrencyRateCheck.bind(m),setOpenSeaEnabled:m.setOpenSeaEnabled.bind(m),getUseRequestQueue:this.preferencesController.getUseRequestQueue.bind(this.preferencesController),getProviderConfig:()=>this.networkController.state.providerConfig,setSecurityAlertsEnabled:m.setSecurityAlertsEnabled.bind(m),setAddSnapAccountEnabled:m.setAddSnapAccountEnabled.bind(m),setUseExternalNameSources:m.setUseExternalNameSources.bind(m),setUseTransactionSimulations:m.setUseTransactionSimulations.bind(m),setUseRequestQueue:this.setUseRequestQueue.bind(this),setIpfsGateway:m.setIpfsGateway.bind(m),setIsIpfsGatewayEnabled:m.setIsIpfsGatewayEnabled.bind(m),setUseAddressBarEnsResolution:m.setUseAddressBarEnsResolution.bind(m),setParticipateInMetaMetrics:h.setParticipateInMetaMetrics.bind(h),setCurrentLocale:m.setCurrentLocale.bind(m),setIncomingTransactionsPreferences:m.setIncomingTransactionsPreferences.bind(m),markPasswordForgotten:this.markPasswordForgotten.bind(this),unMarkPasswordForgotten:this.unMarkPasswordForgotten.bind(this),getRequestAccountTabIds:this.getRequestAccountTabIds,getOpenMetamaskTabsIds:this.getOpenMetamaskTabsIds,markNotificationPopupAsAutomaticallyClosed:()=>this.notificationManager.markAsAutomaticallyClosed(),requestUserApproval:v.addAndShowApprovalRequest.bind(v),addNewAccount:this.addNewAccount.bind(this),getSeedPhrase:this.getSeedPhrase.bind(this),resetAccount:this.resetAccount.bind(this),removeAccount:this.removeAccount.bind(this),importAccountWithStrategy:this.importAccountWithStrategy.bind(this),getAccountsBySnapId:e=>(0,lt.getAccountsBySnapId)(this,e),connectHardware:this.connectHardware.bind(this),forgetDevice:this.forgetDevice.bind(this),checkHardwareStatus:this.checkHardwareStatus.bind(this),unlockHardwareWalletAccount:this.unlockHardwareWalletAccount.bind(this),attemptLedgerTransportCreation:this.attemptLedgerTransportCreation.bind(this),submitQRHardwareCryptoHDKey:o.submitQRCryptoHDKey.bind(o),submitQRHardwareCryptoAccount:o.submitQRCryptoAccount.bind(o),cancelSyncQRHardware:o.cancelQRSynchronization.bind(o),submitQRHardwareSignature:o.submitQRSignature.bind(o),cancelQRHardwareSignRequest:o.cancelQRSignRequest.bind(o),submitPassword:this.submitPassword.bind(this),verifyPassword:this.verifyPassword.bind(this),setProviderType:e=>this.networkController.setProviderType(e),setActiveNetwork:e=>this.networkController.setActiveNetwork(e),setNetworkClientIdForDomain:(e,t)=>this.selectedNetworkController.setNetworkClientIdForDomain(e,t),rollbackToPreviousProvider:u.rollbackToPreviousProvider.bind(u),removeNetworkConfiguration:u.removeNetworkConfiguration.bind(u),upsertNetworkConfiguration:this.networkController.upsertNetworkConfiguration.bind(this.networkController),getCurrentNetworkEIP1559Compatibility:this.networkController.getEIP1559Compatibility.bind(this.networkController),getNetworkConfigurationByNetworkClientId:this.networkController.getNetworkConfigurationByNetworkClientId.bind(this.networkController),setSelectedAddress:e=>{const t=this.accountsController.getAccountByAddress(e);if(!t)throw new Error(`No account found for address: ${e}`);this.accountsController.setSelectedAccount(t.id),this.preferencesController.setSelectedAddress(e)},addToken:w.addToken.bind(w),updateTokenType:w.updateTokenType.bind(w),setFeatureFlag:m.setFeatureFlag.bind(m),setPreference:m.setPreference.bind(m),addKnownMethodData:m.addKnownMethodData.bind(m),setDismissSeedBackUpReminder:m.setDismissSeedBackUpReminder.bind(m),setDisabledRpcMethodPreference:m.setDisabledRpcMethodPreference.bind(m),getRpcMethodPreferences:m.getRpcMethodPreferences.bind(m),setAdvancedGasFee:m.setAdvancedGasFee.bind(m),setTheme:m.setTheme.bind(m),setSnapsAddSnapAccountModalDismissed:m.setSnapsAddSnapAccountModalDismissed.bind(m),setSelectedInternalAccount:e=>{const t=this.accountsController.getAccount(e);t&&(this.preferencesController.setSelectedAddress(t.address),this.accountsController.setSelectedAccount(e))},setAccountName:e.setAccountName.bind(e),setAccountLabel:(e,t)=>{this.preferencesController.setAccountLabel(e,t);const r=this.accountsController.getAccountByAddress(e);if(r===undefined)throw new Error(`No account found for address: ${e}`);this.accountsController.setAccountName(r.id,t)},getTokenStandardAndDetails:this.getTokenStandardAndDetails.bind(this),getTokenSymbol:this.getTokenSymbol.bind(this),addNft:s.addNft.bind(s),addNftVerifyOwnership:s.addNftVerifyOwnership.bind(s),removeAndIgnoreNft:s.removeAndIgnoreNft.bind(s),removeNft:s.removeNft.bind(s),checkAndUpdateAllNftsOwnershipStatus:s.checkAndUpdateAllNftsOwnershipStatus.bind(s),checkAndUpdateSingleNftOwnershipStatus:s.checkAndUpdateSingleNftOwnershipStatus.bind(s),isNftOwner:s.isNftOwner.bind(s),setAddressBook:t.set.bind(t),removeFromAddressBook:t.delete.bind(t),setLastActiveTime:n.setLastActiveTime.bind(n),setCurrentExtensionPopupId:n.setCurrentExtensionPopupId.bind(n),setDefaultHomeActiveTabName:n.setDefaultHomeActiveTabName.bind(n),setConnectedStatusPopoverHasBeenShown:n.setConnectedStatusPopoverHasBeenShown.bind(n),setRecoveryPhraseReminderHasBeenShown:n.setRecoveryPhraseReminderHasBeenShown.bind(n),setRecoveryPhraseReminderLastShown:n.setRecoveryPhraseReminderLastShown.bind(n),setTermsOfUseLastAgreed:n.setTermsOfUseLastAgreed.bind(n),setSurveyLinkLastClickedOrClosed:n.setSurveyLinkLastClickedOrClosed.bind(n),setNewPrivacyPolicyToastClickedOrClosed:n.setNewPrivacyPolicyToastClickedOrClosed.bind(n),setNewPrivacyPolicyToastShownDate:n.setNewPrivacyPolicyToastShownDate.bind(n),setSnapsInstallPrivacyWarningShownStatus:n.setSnapsInstallPrivacyWarningShownStatus.bind(n),setOutdatedBrowserWarningLastShown:n.setOutdatedBrowserWarningLastShown.bind(n),setShowTestnetMessageInDropdown:n.setShowTestnetMessageInDropdown.bind(n),setShowBetaHeader:n.setShowBetaHeader.bind(n),setShowPermissionsTour:n.setShowPermissionsTour.bind(n),setShowAccountBanner:n.setShowAccountBanner.bind(n),setShowNetworkBanner:n.setShowNetworkBanner.bind(n),updateNftDropDownState:n.updateNftDropDownState.bind(n),setFirstTimeUsedNetwork:n.setFirstTimeUsedNetwork.bind(n),setSwitchedNetworkDetails:n.setSwitchedNetworkDetails.bind(n),clearSwitchedNetworkDetails:n.clearSwitchedNetworkDetails.bind(n),setSwitchedNetworkNeverShowMessage:n.setSwitchedNetworkNeverShowMessage.bind(n),tryReverseResolveAddress:c.reverseResolveAddress.bind(c),setLocked:this.setLocked.bind(this),createNewVaultAndKeychain:this.createNewVaultAndKeychain.bind(this),createNewVaultAndRestore:this.createNewVaultAndRestore.bind(this),exportAccount:this.exportAccount.bind(this),updateTransaction:f.updateTransaction.bind(f),approveTransactionsWithSameNonce:f.approveTransactionsWithSameNonce.bind(f),createCancelTransaction:this.createCancelTransaction.bind(this),createSpeedUpTransaction:this.createSpeedUpTransaction.bind(this),estimateGas:this.estimateGas.bind(this),getNextNonce:this.getNextNonce.bind(this),addTransaction:(e,t)=>(0,dt.addTransaction)(this.getAddTransactionRequest({transactionParams:e,transactionOptions:t,waitForSubmit:!1}),this.updateSecurityAlertResponseByTxId.bind(this)),addTransactionAndWaitForPublish:(e,t)=>(0,dt.addTransaction)(this.getAddTransactionRequest({transactionParams:e,transactionOptions:t,waitForSubmit:!0}),this.updateSecurityAlertResponseByTxId.bind(this)),createTransactionEventFragment:ye.createTransactionEventFragmentWithTxId.bind(null,this.getTransactionMetricsRequest()),getTransactions:this.txController.getTransactions.bind(this.txController),updateEditableParams:this.txController.updateEditableParams.bind(this.txController),updateTransactionGasFees:f.updateTransactionGasFees.bind(f),updateTransactionSendFlowHistory:f.updateTransactionSendFlowHistory.bind(f),updatePreviousGasParams:f.updatePreviousGasParams.bind(f),abortTransactionSigning:f.abortTransactionSigning.bind(f),getLayer1GasFee:f.getLayer1GasFee.bind(f),decryptMessage:this.decryptMessageController.decryptMessage.bind(this.decryptMessageController),decryptMessageInline:this.decryptMessageController.decryptMessageInline.bind(this.decryptMessageController),cancelDecryptMessage:this.decryptMessageController.cancelDecryptMessage.bind(this.decryptMessageController),encryptionPublicKey:this.encryptionPublicKeyController.encryptionPublicKey.bind(this.encryptionPublicKeyController),cancelEncryptionPublicKey:this.encryptionPublicKeyController.cancelEncryptionPublicKey.bind(this.encryptionPublicKeyController),setSeedPhraseBackedUp:g.setSeedPhraseBackedUp.bind(g),completeOnboarding:g.completeOnboarding.bind(g),setFirstTimeFlowType:g.setFirstTimeFlowType.bind(g),setAlertEnabledness:r.setAlertEnabledness.bind(r),setUnconnectedAccountAlertShown:r.setUnconnectedAccountAlertShown.bind(r),setWeb3ShimUsageAlertDismissed:r.setWeb3ShimUsageAlertDismissed.bind(r),removePermissionsFor:this.removePermissionsFor,approvePermissionsRequest:this.acceptPermissionsRequest,rejectPermissionsRequest:this.rejectPermissionsRequest,...(0,rt.getPermissionBackgroundApiMethods)(C),disableSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:disable"),enableSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:enable"),updateSnap:(e,t)=>(this.controllerMessenger.call("SnapController:install",e,t),null),removeSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:remove"),handleSnapRequest:this.handleSnapRequest.bind(this),revokeDynamicSnapPermissions:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:revokeDynamicPermissions"),dismissNotifications:this.dismissNotifications.bind(this),markNotificationsAsRead:this.markNotificationsAsRead.bind(this),disconnectOriginFromSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:disconnectOrigin"),updateNetworksList:this.updateNetworksList.bind(this),updateAccountsList:this.updateAccountsList.bind(this),updateHiddenAccountsList:this.updateHiddenAccountsList.bind(this),getPhishingResult:async e=>(await A.maybeUpdateState(),A.test(e)),deleteInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:deleteInterface"),updateInterfaceState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:updateInterfaceState"),fetchAndSetQuotes:b.fetchAndSetQuotes.bind(b),setSelectedQuoteAggId:b.setSelectedQuoteAggId.bind(b),resetSwapsState:b.resetSwapsState.bind(b),setSwapsTokens:b.setSwapsTokens.bind(b),clearSwapsQuotes:b.clearSwapsQuotes.bind(b),setApproveTxId:b.setApproveTxId.bind(b),setTradeTxId:b.setTradeTxId.bind(b),setSwapsTxGasPrice:b.setSwapsTxGasPrice.bind(b),setSwapsTxGasLimit:b.setSwapsTxGasLimit.bind(b),setSwapsTxMaxFeePerGas:b.setSwapsTxMaxFeePerGas.bind(b),setSwapsTxMaxFeePriorityPerGas:b.setSwapsTxMaxFeePriorityPerGas.bind(b),safeRefetchQuotes:b.safeRefetchQuotes.bind(b),stopPollingForQuotes:b.stopPollingForQuotes.bind(b),setBackgroundSwapRouteState:b.setBackgroundSwapRouteState.bind(b),resetPostFetchState:b.resetPostFetchState.bind(b),setSwapsErrorKey:b.setSwapsErrorKey.bind(b),setInitialGasEstimate:b.setInitialGasEstimate.bind(b),setCustomApproveTxData:b.setCustomApproveTxData.bind(b),setSwapsLiveness:b.setSwapsLiveness.bind(b),setSwapsFeatureFlags:b.setSwapsFeatureFlags.bind(b),setSwapsUserFeeLevel:b.setSwapsUserFeeLevel.bind(b),setSwapsQuotesPollingLimitEnabled:b.setSwapsQuotesPollingLimitEnabled.bind(b),fetchSmartTransactionFees:k.getFees.bind(k),clearSmartTransactionFees:k.clearFees.bind(k),submitSignedTransactions:k.submitSignedTransactions.bind(k),cancelSmartTransaction:k.cancelSmartTransaction.bind(k),fetchSmartTransactionsLiveness:k.fetchLiveness.bind(k),updateSmartTransaction:k.updateSmartTransaction.bind(k),setStatusRefreshInterval:k.setStatusRefreshInterval.bind(k),trackMetaMetricsEvent:h.trackEvent.bind(h),trackMetaMetricsPage:h.trackPage.bind(h),createEventFragment:h.createEventFragment.bind(h),updateEventFragment:h.updateEventFragment.bind(h),finalizeEventFragment:h.finalizeEventFragment.bind(h),resolvePendingApproval:this.resolvePendingApproval,rejectPendingApproval:this.rejectPendingApproval,resetViewedNotifications:p.resetViewed.bind(p),updateViewedNotifications:p.updateViewed.bind(p),currencyRateStartPollingByNetworkClientId:a.startPollingByNetworkClientId.bind(a),currencyRateStopPollingByPollingToken:a.stopPollingByPollingToken.bind(a),gasFeeStartPollingByNetworkClientId:d.startPollingByNetworkClientId.bind(d),gasFeeStopPollingByPollingToken:d.stopPollingByPollingToken.bind(d),getGasFeeTimeEstimate:d.getTimeEstimate.bind(d),addPollingTokenToAppState:n.addPollingToken.bind(n),removePollingTokenFromAppState:n.removePollingToken.bind(n),backupUserData:S.backupUserData.bind(S),restoreUserData:S.restoreUserData.bind(S),detectTokens:l.detectTokens.bind(l),detectNfts:i.detectNfts.bind(i),addDetectedTokens:w.addDetectedTokens.bind(w),addImportedTokens:w.addTokens.bind(w),ignoreTokens:w.ignoreTokens.bind(w),getBalancesInSingleCall:y.getBalancesInSingleCall.bind(y),throwTestError:this.throwTestError.bind(this),updateProposedNames:this.nameController.updateProposedNames.bind(this.nameController),setName:this.nameController.setName.bind(this.nameController)}}async exportAccount(e,t){return await this.verifyPassword(t),this.keyringController.exportAccount(t,e)}async getTokenStandardAndDetails(e,t,r){var n,o;const{tokenList:s}=this.tokenListController.state,{tokens:i}=this.tokensController.state,a={...me.STATIC_MAINNET_TOKEN_LIST[e.toLowerCase()]||{},...s[e.toLowerCase()]||{},...i.find((({address:t})=>(0,ge.isEqualCaseInsensitive)(t,e)))||{}},l=(0,ge.isEqualCaseInsensitive)(a.standard,te.TokenStandard.ERC20)||!0===a.erc20,c=!(r||(0,ge.isEqualCaseInsensitive)(a.standard,te.TokenStandard.ERC1155)||(0,ge.isEqualCaseInsensitive)(a.standard,te.TokenStandard.ERC721)||a.erc721),d=a.decimals!==undefined&&a.symbol;let h;if(l||c&&d)try{const r=t?await(0,pe.fetchTokenBalance)(e,t,this.provider):undefined;h={address:e,balance:r,standard:te.TokenStandard.ERC20,decimals:a.decimals,symbol:a.symbol}}catch(e){w.default.warn(`Failed to get token balance. Error: ${e}`)}h===undefined&&(h=await this.assetsContractController.getTokenStandardAndDetails(e,t,r));if((0,ge.isEqualCaseInsensitive)(h.standard,te.TokenStandard.ERC1155))try{const n=await(0,pe.fetchERC1155Balance)(e,t,r,this.provider),o=null!=n&&n._hex?parseInt(n._hex,16).toString():null;h={...h,balance:o}}catch(e){w.default.warn("Failed to get token balance. Error:",e)}return{...h,decimals:null===(n=h)||void 0===n||null===(n=n.decimals)||void 0===n?void 0:n.toString(10),balance:null===(o=h)||void 0===o||null===(o=o.balance)||void 0===o?void 0:o.toString(10)}}async getTokenSymbol(e){try{const t=await this.assetsContractController.getTokenStandardAndDetails(e);return null==t?void 0:t.symbol}catch(e){return null}}async createNewVaultAndKeychain(e){const t=await this.createVaultMutex.acquire();try{const t=await this.keyringController.createNewVaultAndKeychain(e),r=await this.keyringController.getAccounts();return this.preferencesController.setAddresses(r),this.selectFirstAccount(),t}finally{t()}}async createNewVaultAndRestore(e,r){const n=await this.createVaultMutex.acquire();try{const n=t.from(r);this.preferencesController.setAddresses([]),this.permissionController.clearState(),this.snapController.clearState(),this.notificationController.clear(),this.accountTracker.clearAccounts(),this.txController.clearUnapprovedTransactions(),this.tokenDetectionController.enable();const i=await this.keyringController.createNewVaultAndRestore(e,this._convertMnemonicToWordlistIndices(n)),{chainId:a}=this.networkController.state.providerConfig,l=new v.default(this.provider),c=await this.keyringController.getAccounts();let d=c[c.length-1];for(let e=c.length;;e++){if("0x0"===await this.getBalance(d,l)){var o,s;await this.tokenDetectionController.detectTokens({selectedAddress:d});const t=null===(o=this.tokensController.state.allTokens)||void 0===o||null===(o=o[a])||void 0===o?void 0:o[d],r=null===(s=this.tokensController.state.allDetectedTokens)||void 0===s||null===(s=s[a])||void 0===s?void 0:s[d];if(0===((null==t?void 0:t.length)??0)&&0===((null==r?void 0:r.length)??0)){1!==e&&await this.removeAccount(d);break}}({addedAccountAddress:d}=await this.keyringController.addNewAccount(e))}return this.setLedgerTransportPreference(),this.selectFirstAccount(),i}finally{n()}}_convertMnemonicToWordlistIndices(e){const t=e.toString().split(" ").map((e=>Q.wordlist.indexOf(e)));return new Uint8Array(new Uint16Array(t).buffer)}_convertEnglishWordlistIndicesToCodepoints(e){return t.from(Array.from(new Uint16Array(e.buffer)).map((e=>Q.wordlist[e])).join(" "))}getBalance(e,t){return new Promise(((r,n)=>{const o=this.accountTracker.store.getState().accounts[e];o&&o.balance?r(o.balance):t.getBalance(e,((e,t)=>{e?(n(e),w.default.error(e)):r(t||"0x0")}))}))}async submitPassword(e){await this.keyringController.submitPassword(e);try{await this.blockTracker.checkForLatestBlock()}catch(e){w.default.error("Error while unlocking extension.",e)}await this.accountsController.updateAccounts(),this.setLedgerTransportPreference()}async _loginUser(e){try{await this.submitPassword(e),await this.accountTracker.updateAccountsAllActiveNetworks()}finally{this._startUISync()}}_startUISync(){this.emit("startUISync"),this.startUISync=!0,this.memStore.subscribe(this.sendUpdate.bind(this))}async submitEncryptionKey(){try{const{loginToken:e,loginSalt:t}=await this.extension.storage.session.get(["loginToken","loginSalt"]);if(e&&t){const{vault:r}=this.keyringController.state;if(JSON.parse(r).salt!==t)return console.warn("submitEncryptionKey: Stored salt and vault salt do not match"),void await this.clearLoginArtifacts();await this.keyringController.submitEncryptionKey(e,t)}}catch(e){throw await this.clearLoginArtifacts(),e}}async clearLoginArtifacts(){await this.extension.storage.session.remove(["loginToken","loginSalt"])}async verifyPassword(e){await this.keyringController.verifyPassword(e)}selectFirstAccount(){const{identities:e}=this.preferencesController.store.getState(),[t]=Object.keys(e);this.preferencesController.setSelectedAddress(t);const[r]=this.accountsController.listAccounts();this.accountsController.setSelectedAccount(r.id)}getPrimaryKeyringMnemonic(){const[e]=this.keyringController.getKeyringsByType(ie.KeyringType.hdKeyTree);if(!e.mnemonic)throw new Error("Primary keyring mnemonic unavailable.");return e.mnemonic}async getKeyringForDevice(e,t=null){var r,n,o,s;const i=null===(r=this.opts.overrides)||void 0===r?void 0:r.keyrings;let a=null;switch(e){case se.HardwareDeviceNames.trezor:a=(null==i||null===(n=i.trezor)||void 0===n?void 0:n.type)||k.TrezorKeyring.type;break;case se.HardwareDeviceNames.ledger:a=(null==i||null===(o=i.ledger)||void 0===o?void 0:o.type)||f.LedgerKeyring.type;break;case se.HardwareDeviceNames.qr:a=S.MetaMaskKeyring.type;break;case se.HardwareDeviceNames.lattice:a=(null==i||null===(s=i.lattice)||void 0===s?void 0:s.type)||y.default.type;break;default:throw new Error("MetamaskController:getKeyringForDevice - Unknown device")}let[l]=await this.keyringController.getKeyringsByType(a);if(l||(l=await this.keyringController.addNewKeyring(a)),t&&l.setHdPath&&l.setHdPath(t),e===se.HardwareDeviceNames.lattice&&(l.appName="MetaMask"),e===se.HardwareDeviceNames.trezor){const e=l.getModel();this.appStateController.setTrezorModel(e)}return l.network=this.networkController.state.providerConfig.type,l}async attemptLedgerTransportCreation(){const e=await this.getKeyringForDevice(se.HardwareDeviceNames.ledger);return await e.attemptMakeApp()}async connectHardware(e,t,r){const n=await this.getKeyringForDevice(e,r);let o=[];switch(t){case-1:o=await n.getPreviousPage();break;case 1:o=await n.getNextPage();break;default:o=await n.getFirstPage()}const s=await this.keyringController.getAccounts(),i=[...new Set(s.concat(o.map((e=>e.address.toLowerCase()))))];return this.accountTracker.syncWithAddresses(i),o}async checkHardwareStatus(e,t){return(await this.getKeyringForDevice(e,t)).isUnlocked()}async forgetDevice(e){const t=await this.getKeyringForDevice(e);for(const e of t.accounts)await this.removeAccount(e);return t.forgetDevice(),!0}async getAccountType(e){switch(await this.keyringController.getAccountKeyringType(e)){case ie.KeyringType.trezor:case ie.KeyringType.lattice:case ie.KeyringType.qr:case ie.KeyringType.ledger:return"hardware";case ie.KeyringType.imported:return"imported";case ie.KeyringType.snap:return"snap";default:return"MetaMask"}}async getDeviceModel(e){const t=await this.keyringController.getKeyringForAccount(e);switch(t.type){case ie.KeyringType.trezor:return t.getModel();case ie.KeyringType.qr:return t.getName();case ie.KeyringType.ledger:return se.HardwareDeviceNames.ledger;case ie.KeyringType.lattice:return se.HardwareDeviceNames.lattice;default:return undefined}}getAccountLabel(e,t,r){return`${e[0].toUpperCase()}${e.slice(1)} ${parseInt(t,10)+1} ${r||""}`.trim()}async unlockHardwareWalletAccount(e,t,r,n){const o=await this.getKeyringForDevice(t,r);o.setAccountToUnlock(e);const s=await this.keyringController.getAccounts(),i=await this.keyringController.addNewAccountForKeyring(o),a=await this.keyringController.getAccounts();this.preferencesController.setAddresses(a),a.forEach((r=>{if(!s.includes(r)){const s=this.getAccountLabel(t===se.HardwareDeviceNames.qr?o.getName():t,e,n);this.preferencesController.setAccountLabel(r,s),this.preferencesController.setSelectedAddress(r);const i=this.accountsController.getAccountByAddress(r);this.accountsController.setAccountName(i.id,s)}}));const l=this.accountsController.listAccounts(),{identities:c}=this.preferencesController.store.getState();return{...i,identities:c,accounts:l}}async addNewAccount(e){const t=await this.keyringController.getAccounts(),{addedAccountAddress:r}=await this.keyringController.addNewAccount(e);return t.includes(r)||this.preferencesController.setSelectedAddress(r),r}async getSeedPhrase(e){return this._convertEnglishWordlistIndicesToCodepoints(await this.keyringController.exportSeedPhrase(e))}async resetAccount(){const e=this.accountsController.getSelectedAccount().address;return this.txController.wipeTransactions(!1,e),this.smartTransactionsController.wipeSmartTransactions({address:e,ignoreNetwork:!1}),this.networkController.resetConnection(),e}async getPermittedAccounts(e,{suppressUnauthorizedError:t=!0}={}){try{return await this.permissionController.executeRestrictedMethod(e,ae.RestrictedMethods.eth_accounts)}catch(e){if(t&&e.code===m.errorCodes.provider.unauthorized)return[];throw e}}removeAllAccountPermissions(e){this.permissionController.updatePermissionsByCaveat(ae.CaveatTypes.restrictReturnedAccounts,(t=>rt.CaveatMutatorFactories[ae.CaveatTypes.restrictReturnedAccounts].removeAccount(e,t)))}async removeAccount(e){this.removeAllAccountPermissions(e);const t=await this.keyringController.getKeyringForAccount(e);await this.keyringController.removeAccount(e);const r=t?await t.getAccounts():{};var n;0===(null==r?void 0:r.length)&&(null===(n=t.destroy)||void 0===n||n.call(t));return e}async importAccountWithStrategy(e,t){const{importedAccountAddress:r}=await this.keyringController.importAccountWithStrategy(e,t);this.preferencesController.setSelectedAddress(r)}getAddTransactionRequest({transactionParams:e,transactionOptions:t,dappRequest:r}){var n;return{dappRequest:r,networkClientId:(null==r?void 0:r.networkClientId)??this.networkController.state.selectedNetworkClientId,selectedAccount:this.accountsController.getAccountByAddress(e.from),transactionController:this.txController,transactionOptions:t,transactionParams:e,userOperationController:this.userOperationController,ppomController:this.ppomController,securityAlertsEnabled:null===(n=this.preferencesController.store.getState())||void 0===n?void 0:n.securityAlertsEnabled,chainId:this.networkController.state.providerConfig.chainId}}async getCurrentAccountEIP1559Compatibility(){return!0}async createCancelTransaction(e,t,r){await this.txController.stopTransaction(e,t,r);return this.getState()}async createSpeedUpTransaction(e,t,r){await this.txController.speedUpTransaction(e,t,r);return this.getState()}async estimateGas(e){return new Promise(((t,r)=>new A.default(this.provider).estimateGas(e,((e,n)=>e?r(e):t(n.toString(16))))))}async updateSecurityAlertResponseByTxId(e,t){let r=!1;for(;!r;)r=te.SIGNING_METHODS.includes(e.method)?Object.values(this.signatureController.messages).find((t=>{var r;return(null===(r=t.securityAlertResponse)||void 0===r?void 0:r.securityAlertId)===e.securityAlertResponse.securityAlertId})):this.txController.state.transactions.find((t=>{var r;return(null===(r=t.securityAlertResponse)||void 0===r?void 0:r.securityAlertId)===e.securityAlertResponse.securityAlertId})),r||await new Promise((e=>setTimeout(e,100)));te.SIGNING_METHODS.includes(e.method)?this.appStateController.addSignatureSecurityAlertResponse(t):this.txController.updateSecurityAlertResponse(r.id,t)}markPasswordForgotten(){this.preferencesController.setPasswordForgotten(!0),this.sendUpdate()}unMarkPasswordForgotten(){this.preferencesController.setPasswordForgotten(!1),this.sendUpdate()}setUseRequestQueue(e){this.preferencesController.setUseRequestQueue(e)}setupUntrustedCommunication({connectionStream:e,sender:t,subjectType:r}){const{usePhishDetect:n}=this.preferencesController.store.getState();let o;if(o=r||(t.id&&t.id!==this.extension.runtime.id?L.SubjectType.Extension:L.SubjectType.Website),t.url){const{hostname:r}=new URL(t.url);this.phishingController.maybeUpdateState();const o=this.phishingController.test(r);if(n&&null!=o&&o.result)return this.sendPhishingWarning(e,r),void this.metaMetricsController.trackEvent({event:he.MetaMetricsEventName.PhishingPageDisplayed,category:he.MetaMetricsEventCategory.Phishing,properties:{url:r}})}const s=(0,qe.setupMultiplex)(e);this.setupProviderConnection(s.createStream("metamask-provider"),t,o),t.url&&this.setupPublicConfig(s.createStream("publicConfig"))}setupTrustedCommunication(e,t){const r=(0,qe.setupMultiplex)(e);this.setupControllerConnection(r.createStream("controller")),this.setupProviderConnection(r.createStream("provider"),t,L.SubjectType.Internal)}setupPhishingCommunication({connectionStream:e}){const{usePhishDetect:t}=this.preferencesController.store.getState();if(!t)return;const r=(0,qe.setupMultiplex)(e).createStream("metamask-phishing-safelist");r.on("data",(0,Ye.default)({safelistPhishingDomain:this.safelistPhishingDomain.bind(this),backToSafetyPhishingWarning:this.backToSafetyPhishingWarning.bind(this)},r))}sendPhishingWarning(e,t){(0,qe.setupMultiplex)(e).createStream("phishing").write({hostname:t})}setupControllerConnection(e){const t=this.getApi();this.activeControllerConnections+=1,this.emit("controllerConnectionChanged",this.activeControllerConnections),e.on("data",(0,Ye.default)(t,e,this.store,this.localStoreApiWrapper));const r=t=>{e._writableState.ended||e.write({jsonrpc:"2.0",method:"sendUpdate",params:[t]})};this.on("update",r);const n=()=>{e._writableState.ended||e.write({jsonrpc:"2.0",method:"startUISync"})};this.startUISync?n():this.once("startUISync",n),e.on("end",(()=>{this.activeControllerConnections-=1,this.emit("controllerConnectionChanged",this.activeControllerConnections),this.removeListener("update",r)}))}setupProviderConnection(e,t,r){let n,s;n=r===L.SubjectType.Internal?de.ORIGIN_METAMASK:r===L.SubjectType.Snap?t.snapId:new URL(t.url).origin,t.id&&t.id!==this.extension.runtime.id&&this.subjectMetadataController.addSubjectMetadata({origin:n,extensionId:t.id,subjectType:L.SubjectType.Extension}),t.tab&&t.tab.id&&(s=t.tab.id);const i=this.setupProviderEngine({origin:n,sender:t,subjectType:r,tabId:s}),a=(0,c.createEngineStream)({engine:i}),l=this.addConnection(n,{engine:i});(0,o.default)(e,a,e,(e=>{i._middleware.forEach((e=>{e.destroy&&"function"==typeof e.destroy&&e.destroy()})),l&&this.removeConnection(n,l),e&&w.default.error(e)}))}setupSnapProvider(e,t){this.setupUntrustedCommunication({connectionStream:t,sender:{snapId:e},subjectType:L.SubjectType.Snap})}setupProviderEngine({origin:e,subjectType:t,sender:r,tabId:n}){const o=new l.JsonRpcEngine;o.push((0,Le.default)({origin:e})),o.push((0,D.createSelectedNetworkMiddleware)(this.controllerMessenger));const s=this.selectedNetworkController.getProviderAndBlockTracker(e),i=(0,Y.createQueuedRequestMiddleware)({enqueueRequest:this.queuedRequestController.enqueueRequest.bind(this.queuedRequestController),useRequestQueue:this.preferencesController.getUseRequestQueue.bind(this.preferencesController),methodsWithConfirmation:ee.methodsWithConfirmation});o.push(i);const a=(0,g.default)(s),c=(0,C.default)(s);return c.events.on("notification",(e=>o.emit("notification",e))),we.isManifestV3&&o.push((0,Oe.default)()),n&&o.push((0,_e.default)({tabId:n})),o.push((0,Fe.default)({origin:e})),o.push(this.permissionLogController.createMiddleware()),o.push((0,Pe.createPPOMMiddleware)(this.ppomController,this.preferencesController,this.networkController,this.appStateController,this.updateSecurityAlertResponseByTxId.bind(this))),o.push((0,nt.default)({trackEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController),getMetricsState:this.metaMetricsController.store.getState.bind(this.metaMetricsController.store),getAccountType:this.getAccountType.bind(this),getDeviceModel:this.getDeviceModel.bind(this),snapAndHardwareMessenger:this.controllerMessenger.getRestricted({name:"SnapAndHardwareMessenger",allowedActions:["KeyringController:getKeyringForAccount","SnapController:get","AccountsController:getSelectedAccount"]}),appStateController:this.appStateController})),t===L.SubjectType.Website&&o.push((0,Be.default)({location:r.url,registerOnboarding:this.onboardingController.registerOnboarding})),o.push((0,Ue.createMethodMiddleware)({origin:e,subjectType:t,addSubjectMetadata:this.subjectMetadataController.addSubjectMetadata.bind(this.subjectMetadataController),metamaskState:this.getState(),getProviderState:this.getProviderState.bind(this),getUnlockPromise:this.appStateController.getUnlockPromise.bind(this.appStateController),handleWatchAssetRequest:this.handleWatchAssetRequest.bind(this),requestUserApproval:this.approvalController.addAndShowApprovalRequest.bind(this.approvalController),startApprovalFlow:this.approvalController.startFlow.bind(this.approvalController),endApprovalFlow:this.approvalController.endFlow.bind(this.approvalController),setApprovalFlowLoadingText:this.approvalController.setFlowLoadingText.bind(this.approvalController),showApprovalSuccess:this.approvalController.success.bind(this.approvalController),showApprovalError:this.approvalController.error.bind(this.approvalController),sendMetrics:this.metaMetricsController.trackEvent.bind(this.metaMetricsController),getAccounts:this.getPermittedAccounts.bind(this,e),getPermissionsForOrigin:this.permissionController.getPermissions.bind(this.permissionController,e),hasPermission:this.permissionController.hasPermission.bind(this.permissionController,e),hasPermissions:this.permissionController.hasPermissions.bind(this.permissionController,e),requestAccountsPermission:this.permissionController.requestPermissions.bind(this.permissionController,{origin:e},{eth_accounts:{}}),requestPermissionsForOrigin:this.permissionController.requestPermissions.bind(this.permissionController,{origin:e}),revokePermissionsForOrigin:t=>{try{this.permissionController.revokePermissions({[e]:t})}catch(e){console.log(e)}},getCurrentChainId:()=>this.networkController.state.providerConfig.chainId,getCurrentRpcUrl:()=>this.networkController.state.providerConfig.rpcUrl,getNetworkConfigurations:()=>this.networkController.state.networkConfigurations,upsertNetworkConfiguration:this.networkController.upsertNetworkConfiguration.bind(this.networkController),setActiveNetwork:e=>{this.networkController.setActiveNetwork(e)},findNetworkClientIdByChainId:this.networkController.findNetworkClientIdByChainId.bind(this.networkController),findNetworkConfigurationBy:this.findNetworkConfigurationBy.bind(this),getNetworkClientIdForDomain:this.selectedNetworkController.getNetworkClientIdForDomain.bind(this.selectedNetworkController),setNetworkClientIdForDomain:this.selectedNetworkController.setNetworkClientIdForDomain.bind(this.selectedNetworkController),getUseRequestQueue:this.preferencesController.getUseRequestQueue.bind(this.preferencesController),getProviderConfig:()=>this.networkController.state.providerConfig,setProviderType:e=>this.networkController.setProviderType(e),getWeb3ShimUsageState:this.alertController.getWeb3ShimUsageState.bind(this.alertController),setWeb3ShimUsageRecorded:this.alertController.setWeb3ShimUsageRecorded.bind(this.alertController)})),o.push((0,G.createSnapsMethodMiddleware)(t===L.SubjectType.Snap,{getUnlockPromise:this.appStateController.getUnlockPromise.bind(this.appStateController),getSnaps:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getPermitted",e),requestPermissions:async t=>await this.permissionController.requestPermissions({origin:e},t),getPermissions:this.permissionController.getPermissions.bind(this.permissionController,e),getSnapFile:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getFile",e),installSnaps:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:install",e),getIsLocked:()=>!this.appStateController.isUnlocked(),hasPermission:this.permissionController.hasPermission.bind(this.permissionController,e),getSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:get"),getAllSnaps:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getAll"),handleSnapRpcRequest:t=>this.handleSnapRequest({...t,origin:e}),getAllowedKeyringMethods:(0,ve.keyringSnapPermissionsBuilder)(this.subjectMetadataController,e),createInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:createInterface",e),getInterfaceState:(...t)=>this.controllerMessenger.call("SnapInterfaceController:getInterface",e,...t).state,updateInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:updateInterface",e)})),o.push(a),o.push(c.middleware),t!==L.SubjectType.Internal&&o.push(this.permissionController.createPermissionMiddleware({origin:e})),o.push(this.metamaskMiddleware),o.push((0,d.providerAsMiddleware)(s.provider)),o}setupPublicConfig(e){const t=(0,a.storeAsStream)(this.publicConfigStore);(0,o.default)(t,e,(e=>{t.destroy(),e&&w.default.error(e)}))}addConnection(e,{engine:t}){if(e===de.ORIGIN_METAMASK)return null;this.connections[e]||(this.connections[e]={});const r=(0,M.default)();return this.connections[e][r]={engine:t},r}removeConnection(e,t){const r=this.connections[e];r&&(delete r[t],0===Object.keys(r).length&&delete this.connections[e])}removeAllConnections(e){const t=this.connections[e];t&&Object.keys(t).forEach((t=>{this.removeConnection(e,t)}))}notifyConnections(e,t){const r=this.connections[e];r&&Object.values(r).forEach((e=>{e.engine&&e.engine.emit("notification",t)}))}notifyAllConnections(e){const t="function"==typeof e?t=>e(t):()=>e;Object.keys(this.connections).forEach((e=>{Object.values(this.connections[e]).forEach((async r=>{try{r.engine&&r.engine.emit("notification",await t(e))}catch(e){console.error(e)}}))}))}async _onKeyringControllerUpdate(e){const{keyrings:t}=e,r=t.reduce(((e,{accounts:t})=>e.concat(t)),[]);r.length&&(this.preferencesController.syncAddresses(r),this.accountTracker.syncWithAddresses(r))}_onUnlock(){this.notifyAllConnections((async e=>({method:rt.NOTIFICATION_NAMES.unlockStateChanged,params:{isUnlocked:!0,accounts:await this.getPermittedAccounts(e)}}))),this.unMarkPasswordForgotten(),this.emit("unlock")}_onLock(){this.notifyAllConnections({method:rt.NOTIFICATION_NAMES.unlockStateChanged,params:{isUnlocked:!1}}),this.emit("lock")}_onStateUpdate(e){this.isClientOpenAndUnlocked=e.isUnlocked&&this._isClientOpen,this._notifyChainChange()}privateSendUpdate(){this.emit("update",this.getState())}isUnlocked(){return this.keyringController.state.isUnlocked}getExternalPendingTransactions(e){return this.smartTransactionsController.getTransactions({addressFrom:e,status:"pending"})}async getPendingNonce(e,t){const{nonceDetails:r,releaseLock:n}=await this.txController.getNonceLock(e,undefined),o=r.params.highestSuggested;return n(),o}async getNextNonce(e,t){const r=await this.txController.getNonceLock(e,undefined);return r.releaseLock(),r.nextNonce}throwTestError(e){setTimeout((()=>{const t=new Error(e);throw t.name="TestError",t}))}_addTransactionControllerListeners(){const e=this.getTransactionMetricsRequest();this.controllerMessenger.subscribe("TransactionController:postTransactionBalanceUpdated",ye.handlePostTransactionBalanceUpdate.bind(null,e)),this.controllerMessenger.subscribe("TransactionController:unapprovedTransactionAdded",(t=>(0,ye.handleTransactionAdded)(e,{transactionMeta:t}))),this.controllerMessenger.subscribe("TransactionController:transactionApproved",ye.handleTransactionApproved.bind(null,e)),this.controllerMessenger.subscribe("TransactionController:transactionDropped",ye.handleTransactionDropped.bind(null,e)),this.controllerMessenger.subscribe("TransactionController:transactionConfirmed",ye.handleTransactionConfirmed.bind(null,e)),this.controllerMessenger.subscribe("TransactionController:transactionFailed",ye.handleTransactionFailed.bind(null,e)),this.controllerMessenger.subscribe("TransactionController:transactionNewSwap",(({transactionMeta:e})=>this.swapsController.setTradeTxId(e.id))),this.controllerMessenger.subscribe("TransactionController:transactionNewSwapApproval",(({transactionMeta:e})=>this.swapsController.setApproveTxId(e.id))),this.controllerMessenger.subscribe("TransactionController:transactionRejected",ye.handleTransactionRejected.bind(null,e)),this.controllerMessenger.subscribe("TransactionController:transactionSubmitted",ye.handleTransactionSubmitted.bind(null,e)),this.controllerMessenger.subscribe("TransactionController:transactionStatusUpdated",(({transactionMeta:e})=>{this._onFinishedTransaction(e)}))}getTransactionMetricsRequest(){return{...{createEventFragment:this.metaMetricsController.createEventFragment.bind(this.metaMetricsController),finalizeEventFragment:this.metaMetricsController.finalizeEventFragment.bind(this.metaMetricsController),getEventFragmentById:this.metaMetricsController.getEventFragmentById.bind(this.metaMetricsController),getParticipateInMetrics:()=>this.metaMetricsController.state.participateInMetaMetrics,trackEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController),updateEventFragment:this.metaMetricsController.updateEventFragment.bind(this.metaMetricsController),getAccountType:this.getAccountType.bind(this),getDeviceModel:this.getDeviceModel.bind(this),getEIP1559GasFeeEstimates:this.gasFeeController.fetchGasFeeEstimates.bind(this.gasFeeController),getSelectedAddress:()=>this.preferencesController.store.getState().selectedAddress,getTokenStandardAndDetails:this.getTokenStandardAndDetails.bind(this),getTransaction:e=>this.txController.state.transactions.find((t=>t.id===e)),getIsSmartTransaction:()=>(0,fe.getIsSmartTransaction)(this._getMetaMaskState()),getSmartTransactionByMinedTxHash:e=>this.smartTransactionsController.getSmartTransactionByMinedTxHash(e)},snapAndHardwareMessenger:this.controllerMessenger.getRestricted({name:"SnapAndHardwareMessenger",allowedActions:["KeyringController:getKeyringForAccount","SnapController:get","AccountsController:getSelectedAccount"]}),provider:this.provider}}findNetworkConfigurationBy(e){const{networkConfigurations:t}=this.networkController.state;return Object.values(t).find((t=>Object.keys(e).some((r=>t[r]===e[r]))))||null}async setLedgerTransportPreference(){const e=window.navigator.hid?se.LedgerTransportTypes.webhid:se.LedgerTransportTypes.u2f,t=await this.getKeyringForDevice(se.HardwareDeviceNames.ledger);return null!=t&&t.updateTransportMethod?t.updateTransportMethod(e).catch((e=>{throw e})):undefined}recordFirstTimeInfo(e){if(!("firstTimeInfo"in e)){const t=this.platform.getVersion();e.firstTimeInfo={version:t,date:Date.now()}}}set isClientOpen(e){this._isClientOpen=e}onClientClosed(){try{this.gasFeeController.stopAllPolling(),this.currencyRateController.stopAllPolling(),this.appStateController.clearPollingTokens()}catch(e){console.error(e)}}onEnvironmentTypeClosed(e){const t=de.POLLING_TOKEN_ENVIRONMENT_TYPES[e];this.appStateController.store.getState()[t].forEach((e=>{this.gasFeeController.stopPollingByPollingToken(e),this.currencyRateController.stopPollingByPollingToken(e),this.appStateController.removePollingToken(e,t)}))}safelistPhishingDomain(e){return this.phishingController.bypass(e)}async backToSafetyPhishingWarning(){const e=this.platform.getExtensionURL();await this.platform.switchToAnotherURL(undefined,e)}setLocked(){return this.keyringController.setLocked()}async _onAccountChange(e){const t=(0,rt.getPermittedAccountsByOrigin)(this.permissionController.state);for(const[r,n]of t.entries())n.includes(e)&&this._notifyAccountsChange(r,n);await this.txController.updateIncomingTransactions()}async _notifyAccountsChange(e,t){this.isUnlocked()&&this.notifyConnections(e,{method:rt.NOTIFICATION_NAMES.accountsChanged,params:t.length<2?t:await this.getPermittedAccounts(e)}),this.permissionLogController.updateAccountsHistory(e,t)}async _notifyChainChange(){this.preferencesController.getUseRequestQueue()?this.notifyAllConnections((async e=>({method:rt.NOTIFICATION_NAMES.chainChanged,params:await this.getProviderNetworkState(e)}))):this.notifyAllConnections({method:rt.NOTIFICATION_NAMES.chainChanged,params:await this.getProviderNetworkState()})}async _onFinishedTransaction(e){[X.TransactionStatus.confirmed,X.TransactionStatus.failed].includes(e.status)&&(await this._createTransactionNotifcation(e),this._updateNFTOwnership(e),this._trackTransactionFailure(e))}async _createTransactionNotifcation(e){const{chainId:t}=e;let r={};if(t){const{networkConfigurations:e}=this.networkController.state,n=Object.values(e).find((e=>e.chainId===t));r=(null==n?void 0:n.rpcPrefs)??{}}try{await this.platform.showTransactionNotification(e,r)}catch(e){w.default.error("Failed to create transaction notification",e)}}_updateNFTOwnership(e){var t;const{type:r,txParams:n,chainId:o}=e;if(r!==X.TransactionType.tokenMethodTransferFrom||n===undefined)return;const{data:s,to:i,from:a}=n,l=(0,Ce.parseStandardTokenTransactionData)(s),c=(0,pe.getTokenIdParam)(l)??(0,be.getTokenValueParam)(l),{allNfts:d}=this.nftController.state,h=null==d||null===(t=d[a])||void 0===t||null===(t=t[o])||void 0===t?void 0:t.find((({address:e,tokenId:t})=>(0,ge.isEqualCaseInsensitive)(e,i)&&t===c));h&&this.nftController.checkAndUpdateSingleNftOwnershipStatus(h,!1,{userAddress:a})}_trackTransactionFailure(e){var t;const{txReceipt:r}=e,n=this.getState();r&&"0x0"===r.status&&this.metaMetricsController.trackEvent({event:"Tx Status Update: On-Chain Failure",category:he.MetaMetricsEventCategory.Background,properties:{action:"Transactions",errorMessage:null===(t=e.simulationFails)||void 0===t?void 0:t.reason,numberOfTokens:n.tokens.length,numberOfAccounts:Object.keys(n.accounts).length}},{matomoEvent:!0})}_onUserOperationAdded(e){const t=this.txController.state.transactions.find((t=>t.id===e.id));t&&(t.type===X.TransactionType.swap?this.controllerMessenger.publish("TransactionController:transactionNewSwap",{transactionMeta:t}):t.type===X.TransactionType.swapApproval&&this.controllerMessenger.publish("TransactionController:transactionNewSwapApproval",{transactionMeta:t}))}_onUserOperationTransactionUpdated(e){const t={...e,txParams:{...e.txParams,from:this.preferencesController.getSelectedAddress()}};this.txController.state.transactions.some((e=>e.id===t.id))||this.txController.update((e=>{e.transactions.push(t)})),this.txController.updateTransaction(t,"Generated from user operation"),this.controllerMessenger.publish("TransactionController:transactionStatusUpdated",{updatedTransactionMeta:t})}_publishSmartTransactionHook(e){const t=this._getMetaMaskState(),r=(0,fe.getIsSmartTransaction)(t);if(!r)return{transactionHash:undefined};const n=(0,fe.getFeatureFlagsByChainId)(t);return(0,Se.submitSmartTransactionHook)({transactionMeta:e,transactionController:this.txController,smartTransactionsController:this.smartTransactionsController,controllerMessenger:this.controllerMessenger,isSmartTransaction:r,featureFlags:n})}_getMetaMaskState(){return{metamask:this.getState()}}}async function Mt(e,t){var r;const{currentLocale:n}=e,{chainId:o}=this.networkController.state.providerConfig;await(0,st.updateCurrentLocale)(n),null!==(r=e.incomingTransactionsPreferences)&&void 0!==r&&r[o]?this.txController.startIncomingTransactionPolling():this.txController.stopIncomingTransactionPolling(),ft(this,St,Tt).call(this,e,t),this.controllerMessenger.publish("PreferencesController:stateChange",e,[])}function Tt(e,t){const r=ft(this,vt,Pt).call(this,t),n=ft(this,vt,Pt).call(this,e);r!==n&&(this.tokenListController.updatePreventPollingOnNetworkRestart(!n),n?(w.default.debug("Started token list controller polling"),this.tokenListController.start()):(w.default.debug("Stopped token list controller polling"),this.tokenListController.clearingTokenListData(),this.tokenListController.stop()))}function Pt(e){const{useTokenDetection:t,useTransactionSimulations:r,preferences:n}=e??{},{petnamesEnabled:o}=n??{};return t||o||r}r.default=At}).call(this)}).call(this,e("buffer").Buffer)}}},{package:"$root$",file:"app/scripts/metamask-controller.js"}],[99,{lodash:3509},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var n=e("lodash");r.default={version:2,migrate(e){const t=(0,n.cloneDeep)(e);t.meta.version=2;try{"etherscan"===t.data.config.provider.type&&(t.data.config.provider.type="rpc",t.data.config.provider.rpcTarget="https://rpc.metamask.io/")}catch(e){}return Promise.resolve(t)}}}}},{package:"$root$",file:"app/scripts/migrations/002.js"}],[4,{"../../shared/constants/app":4178,"../../shared/constants/metametrics":4188,"../../shared/modules/browser-runtime.utils":4215,"../../shared/modules/mv3.utils":4228,"../../shared/modules/object.utils":4230,"./first-time-state":31,"./lib/createStreamSink":47,"./lib/ens-ipfs/setup":53,"./lib/get-first-preferred-lang-code":55,"./lib/getObjStructure":56,"./lib/local-store":59,"./lib/migrator":62,"./lib/network-store":63,"./lib/notification-manager":64,"./lib/setup-initial-state-hooks":86,"./lib/setupSentry":87,"./lib/util":97,"./metamask-controller":98,"./migrations":222,"./platforms/extension":223,"@metamask/controller-utils":1094,"@metamask/obs-store":1494,"@metamask/utils":2007,"debounce-stream":2809,"end-of-stream":2848,"eth-rpc-errors":2897,events:2968,"extension-port-stream":2971,loglevel:3515,pump:3693,"webextension-polyfill":4162},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.loadStateFromPersistence=le,r.setupController=de,r.statePersistenceEvents=void 0,e("./lib/setup-initial-state-hooks");var n=U(e("events")),o=U(e("end-of-stream")),s=U(e("pump")),i=U(e("debounce-stream")),a=U(e("loglevel")),l=U(e("webextension-polyfill")),c=e("@metamask/obs-store"),d=e("@metamask/utils"),h=e("@metamask/controller-utils"),u=U(e("extension-port-stream")),p=e("eth-rpc-errors"),g=e("../../shared/constants/app"),C=e("../../shared/constants/metametrics"),m=e("../../shared/modules/browser-runtime.utils"),b=e("../../shared/modules/mv3.utils"),w=e("../../shared/modules/object.utils"),k=U(e("./migrations")),f=U(e("./lib/migrator")),y=U(e("./platforms/extension")),S=U(e("./lib/local-store")),v=(U(e("./lib/network-store")),e("./lib/setupSentry")),A=U(e("./lib/createStreamSink")),M=F(e("./lib/notification-manager")),T=F(e("./metamask-controller")),P=U(e("./first-time-state")),N=U(e("./lib/get-first-preferred-lang-code")),E=U(e("./lib/getObjStructure")),R=U(e("./lib/ens-ipfs/setup")),I=e("./lib/util");function O(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(O=function(e){return e?r:t})(e)}function F(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=O(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var i=o?Object.getOwnPropertyDescriptor(e,s):null;i&&(i.get||i.set)?Object.defineProperty(n,s,i):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}function U(e){return e&&e.__esModule?e:{default:e}}const L=new S.default;global.stateHooks.getMostRecentPersistedState=()=>L.mostRecentRetrievedState;const{sentry:_}=global,D={...P.default},x={[g.ENVIRONMENT_TYPE_POPUP]:!0,[g.ENVIRONMENT_TYPE_NOTIFICATION]:!0,[g.ENVIRONMENT_TYPE_FULLSCREEN]:!0},B=["trezor-connect"];a.default.setLevel("info",!1);const q=new y.default,j=new M.default;let K=0,G=!1,V=!1;const $={},H={};let W,Q;const z={};const Y=new URL("https://metamask.github.io/phishing-warning/v3.0.3/"),J=1e3,X=r.statePersistenceEvents=new n.default,{promise:Z,resolve:ee,reject:te}=(0,I.deferredPromise)(),re=async()=>{const e=await l.default.tabs.query({url:"<all_urls>",windowType:"normal"}).then((e=>((0,m.checkForLastErrorAndLog)(),e))).catch((()=>{(0,m.checkForLastErrorAndLog)()}));for(const t of e)l.default.tabs.sendMessage(t.id,{name:g.EXTENSION_MESSAGES.READY}).then((()=>{(0,m.checkForLastErrorAndLog)()})).catch((()=>{(0,m.checkForLastErrorAndLog)()}))};let ne,oe;function se(){const e=(new Date).toISOString();l.default.storage.session.set({timestamp:e})}async function ie(){try{const e=await le(),t=e.data,r=await(0,N.default)();let n;if(b.isManifestV3){const e=2e3;se(),setInterval(se,e);const t=await l.default.storage.session.get(["isFirstMetaMaskControllerSetup"]);n=(null==t?void 0:t.isFirstMetaMaskControllerSetup)===undefined,await l.default.storage.session.set({isFirstMetaMaskControllerSetup:n})}de(t,r,{},n,e.meta),b.isManifestV3||await async function(){let e;try{const t=new URL("https://metamask.github.io/phishing-warning/v3.0.3/");let r,n;t.hash="#extensionStartup",e=window.document.createElement("iframe"),e.setAttribute("src",t.href),e.setAttribute("sandbox","allow-scripts allow-same-origin");const o=new Promise(((e,t)=>{r=e,n=t}));e.addEventListener("load",r),window.document.body.appendChild(e),setTimeout((()=>n(new ae)),J),await o}catch(e){e instanceof ae?console.warn("Phishing warning page timeout; page not guaranteed to work offline."):console.error("Failed to initialize phishing warning page",e)}finally{e&&e.remove()}}(),await re(),a.default.info("MetaMask initialization complete."),ee()}catch(e){te(e)}}l.default.runtime.onConnect.addListener((async(...e)=>{await Z,ne(...e)})),l.default.runtime.onConnectExternal.addListener((async(...e)=>{await Z,oe(...e)}));class ae extends Error{constructor(){super("Timeout failed")}}async function le(){const e=new f.default({migrations:k.default});if(e.on("error",console.warn),Q=await L.get()||e.generateInitialState(D),Q&&!Q.data&&(Q=e.generateInitialState(D),_.captureMessage("MetaMask - Empty vault found - unable to recover")),e.on("error",(e=>{const t=(0,E.default)(Q);_.captureException(e,{extra:{vaultStructure:t}})})),Q=await e.migrateData(Q),!Q)throw new Error("MetaMask - migrator returned undefined");if(!(0,d.isObject)(Q.meta))throw new Error(`MetaMask - migrator metadata has invalid type '${typeof Q.meta}'`);if("number"!=typeof Q.meta.version)throw new Error(`MetaMask - migrator metadata version has invalid type '${typeof Q.meta.version}'`);if(!(0,d.isObject)(Q.data))throw new Error(`MetaMask - migrator data has invalid type '${typeof Q.data}'`);return L.setMetadata(Q.meta),L.set(Q.data),Q}function ce(e,t,r){const{metaMetricsId:n}=W.metaMetricsController.state;if(!(0,I.shouldEmitDappViewedEvent)(n))return;if(!(0,d.hasProperty)(t.permissions,"eth_accounts"))return;const o=Object.keys(r.store.getState().identities).length,s=t.permissions.eth_accounts.caveats;if(s){const t=s[0].value.length;W.metaMetricsController.trackEvent({event:C.MetaMetricsEventName.DappViewed,category:C.MetaMetricsEventCategory.InpageProvider,referrer:{url:e},properties:{is_first_visit:!1,number_of_accounts:o,number_of_accounts_connected:t}})}}function de(e,t,r,n,d){var m;W=new T.default({infuraProjectId:"b6bf7d3508c941499b10025c0776eaf8",showUserConfirmation:he,initState:e,initLangCode:t,platform:q,notificationManager:j,browser:l.default,getRequestAccountTabIds:()=>H,getOpenMetamaskTabsIds:()=>$,localStore:L,overrides:r,isFirstMetaMaskControllerSetup:n,currentMigrationVersion:d.version,featureFlags:{}}),(0,R.default)({getCurrentChainId:()=>W.networkController.state.providerConfig.chainId,getIpfsGateway:W.preferencesController.getIpfsGateway.bind(W.preferencesController),getUseAddressBarEnsResolution:()=>W.preferencesController.store.getState().useAddressBarEnsResolution,provider:W.provider}),(0,s.default)((0,c.storeAsStream)(W.store),(0,i.default)(1e3),(0,A.default)((async e=>{await L.set(e),X.emit("state-persisted",e)})),(e=>{a.default.error("MetaMask - Persistence pipeline failed",e)})),m=W,global.stateHooks.getSentryAppState=function(){const e=m.memStore.getState();return(0,w.maskObject)(e,v.SENTRY_BACKGROUND_STATE)};const k=()=>K>0||Boolean(Object.keys($).length)||G,f=(e,t)=>{if(!1===e)W.onClientClosed();else{if(t===g.ENVIRONMENT_TYPE_FULLSCREEN&&Boolean(Object.keys($).length))return;W.onEnvironmentTypeClosed(t)}};function y(){let e="";const t=S();t&&(e=String(t)),b.isManifestV3?(l.default.action.setBadgeText({text:e}),l.default.action.setBadgeBackgroundColor({color:"#037DD6"})):(l.default.browserAction.setBadgeText({text:e}),l.default.browserAction.setBadgeBackgroundColor({color:"#037DD6"}))}function S(){let e=W.appStateController.waitingForUnlock.length+W.approvalController.getTotalApprovalCount();return W.preferencesController.getUseRequestQueue()&&(e+=W.queuedRequestController.state.queuedRequestCount),e}ne=async e=>{var t;const n=e.name;if(B.includes(e.name))return;let s=!1;const i=(0,I.getPlatform)(),a=null!==(t=e.sender)&&void 0!==t&&t.url?new URL(e.sender.url):null;if(s=i===g.PLATFORM_FIREFOX?x[n]:(null==a?void 0:a.origin)===`chrome-extension://${l.default.runtime.id}`,s){var c;const t=(null==r||null===(c=r.getPortStream)||void 0===c?void 0:c.call(r,e))||new u.default(e);if(W.isClientOpen=!0,W.setupTrustedCommunication(t,e.sender),n===g.ENVIRONMENT_TYPE_POPUP&&(K+=1,(0,o.default)(t,(()=>{K-=1;const e=k();W.isClientOpen=e,f(e,g.ENVIRONMENT_TYPE_POPUP)}))),n===g.ENVIRONMENT_TYPE_NOTIFICATION&&(G=!0,(0,o.default)(t,(()=>{G=!1;const e=k();W.isClientOpen=e,f(e,g.ENVIRONMENT_TYPE_NOTIFICATION)}))),n===g.ENVIRONMENT_TYPE_FULLSCREEN){const r=e.sender.tab.id;$[r]=!0,(0,o.default)(t,(()=>{delete $[r];const e=k();W.isClientOpen=e,f(e,g.ENVIRONMENT_TYPE_FULLSCREEN)}))}}else if(a&&a.origin===Y.origin&&a.pathname===Y.pathname){var d;const t=(null==r||null===(d=r.getPortStream)||void 0===d?void 0:d.call(r,e))||new u.default(e);W.setupPhishingCommunication({connectionStream:t})}else{if(e.sender&&e.sender.tab&&e.sender.url){const t=e.sender.tab.id,r=new URL(e.sender.url),{origin:n}=r;Object.keys(z).includes(t)||(z[t]=n);const o=W.permissionController.state.subjects[n],s=o!==undefined,i="New Tab"!==e.sender.tab.title;s&&i&&ce(n,o,W.preferencesController),e.onMessage.addListener((e=>{e.data&&e.data.method===g.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS&&(H[n]=t)}))}oe(e)}},oe=e=>{var t;const n=(null==r||null===(t=r.getPortStream)||void 0===t?void 0:t.call(r,e))||new u.default(e);W.setupUntrustedCommunication({connectionStream:n,sender:e.sender})},null!=r&&r.registerConnectListeners&&r.registerConnectListeners(ne,oe),y(),W.decryptMessageController.hub.on(T.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,y),W.encryptionPublicKeyController.hub.on(T.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,y),W.signatureController.hub.on(T.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,y),W.appStateController.on(T.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,y),W.controllerMessenger.subscribe(T.METAMASK_CONTROLLER_EVENTS.APPROVAL_STATE_CHANGE,y),W.controllerMessenger.subscribe(T.METAMASK_CONTROLLER_EVENTS.QUEUED_REQUEST_STATE_CHANGE,y),W.txController.initApprovals(),j.on(M.NOTIFICATION_MANAGER_EVENTS.POPUP_CLOSED,(({automaticallyClosed:e})=>{e?S()>0&&he():(W.signatureController.rejectUnapproved(C.REJECT_NOTIFICATION_CLOSE_SIG),W.decryptMessageController.rejectUnapproved(C.REJECT_NOTIFICATION_CLOSE),W.encryptionPublicKeyController.rejectUnapproved(C.REJECT_NOTIFICATION_CLOSE),Object.values(W.approvalController.state.pendingApprovals).forEach((({id:e,type:t})=>{switch(t){case h.ApprovalType.SnapDialogAlert:case h.ApprovalType.SnapDialogPrompt:W.approvalController.accept(e,null);break;case h.ApprovalType.SnapDialogConfirmation:case g.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.confirmAccountCreation:case g.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.confirmAccountRemoval:case g.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.showSnapAccountRedirect:W.approvalController.accept(e,!1);break;default:W.approvalController.reject(e,p.ethErrors.provider.userRejectedRequest())}}))),y()})),Object.values(W.snapController.state.snaps).some((e=>!e.preinstalled))&&W.snapController.updateBlockedSnaps()}async function he(){const e=await q.getActiveTabs(),t=Boolean(e.find((e=>$[e.id]))),r=e.length>0&&e[0].extData&&e[0].extData.indexOf("vivaldi_tab")>-1;if(!V&&(r||0===K)&&!t){V=!0;try{const e=W.appStateController.getCurrentPopupId();await j.showPopup((e=>W.appStateController.setCurrentPopupId(e)),e)}finally{V=!1}}}const ue=()=>{if(W)return W.metaMetricsController.updateTraits({[C.MetaMetricsUserTrait.InstallDateExt]:(new Date).toISOString().split("T")[0]}),void W.metaMetricsController.addEventBeforeMetricsOptIn({category:C.MetaMetricsEventCategory.App,event:C.MetaMetricsEventName.AppInstalled,properties:{}});setTimeout((()=>{ue()}),1e3)};async function pe(){Boolean(await L.get())||(ue(),q.openExtensionInBrowser()),l.default.tabs.onActivated.addListener((e=>{if(W){const{tabId:t}=e,r=z[t];if(r){const e=W.permissionController.state.subjects[r];e!==undefined&&ce(r,e,W.preferencesController)}}}))}(async function(){await pe(),ie().catch(a.default.error)})()}}},{package:"$root$",file:"app/scripts/background.js"}]],[4],{});